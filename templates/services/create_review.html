{% extends 'base.html' %}
{% load static %}

{% block title %}{% if is_edit %}Editează recenzia{% else %}Lasă o recenzie{% endif %} - {{ order.title }} - Bricli{% endblock %}

{% block content %}
<div class="container py-4 py-md-5">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10 col-xl-8">
            <!-- Modern Header with Gradient -->
            <div class="text-center mb-4 mb-md-5">
                <div class="review-header-icon mb-3">
                    <i class="fas fa-star"></i>
                </div>
                <h1 class="review-header-title mb-2">
                    {% if is_edit %}Editează Recenzia{% else %}Lasă o Recenzie{% endif %}
                </h1>
                <p class="text-muted">Spune-ne despre experiența ta cu {{ order.assigned_craftsman.user.get_full_name|default:order.assigned_craftsman.user.username }}</p>
            </div>

            <!-- Order Info Card - PERMANENT (alert-permanent class) -->
            <div class="alert alert-info alert-permanent border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="row align-items-center g-3">
                    <div class="col-12 col-md-8">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-clipboard-list fs-3 me-3 mt-1" style="opacity: 0.9;"></i>
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-bold" style="color: white;">{{ order.title }}</h6>
                                <small style="opacity: 0.9;">
                                    Meșter: <strong>{{ order.assigned_craftsman.user.get_full_name|default:order.assigned_craftsman.user.username }}</strong>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4 text-md-end">
                        <span class="badge bg-white text-dark px-3 py-2">
                            <i class="fas fa-check-circle text-success me-1"></i>
                            Comandă finalizată
                        </span>
                    </div>
                </div>
            </div>

            <!-- Main Form Card -->
            <div class="card border-0 shadow-sm review-form-card">
                <div class="card-body p-4 p-md-5">
                    <form method="post" enctype="multipart/form-data" id="reviewForm">
                        {% csrf_token %}

                        <!-- Overall Rating Section -->
                        <div class="mb-5">
                            <h5 class="mb-4 rating-section-title">
                                <i class="fas fa-star me-2"></i>
                                Rating general <span class="text-danger">*</span>
                            </h5>

                            <div class="interactive-stars-container">
                                {% for choice in form.rating %}
                                <div class="star-option" data-rating="{{ choice.choice_value }}">
                                    {{ choice.tag }}
                                    <label for="{{ choice.id_for_label }}" class="star-option-label">
                                        <div class="stars-display mb-2">
                                            {% for i in "12345"|make_list %}
                                                <i class="star-icon {% if forloop.counter <= choice.choice_value %}fas{% else %}far{% endif %} fa-star"></i>
                                            {% endfor %}
                                        </div>
                                        <span class="rating-text">{{ choice.choice_label }}</span>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Detailed Ratings Section -->
                        <div class="mb-5">
                            <h5 class="mb-4 rating-section-title">
                                <i class="fas fa-chart-bar me-2"></i>
                                Evaluări detaliate (opțional)
                            </h5>

                            <div class="row g-4">
                                <!-- Quality Rating -->
                                <div class="col-12 col-md-4">
                                    <div class="detailed-rating-card">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="rating-icon-circle bg-primary">
                                                <i class="fas fa-check-circle"></i>
                                            </div>
                                            <h6 class="mb-0 ms-3">Calitate lucrare</h6>
                                        </div>
                                        <div class="rating-options">
                                            {% for choice in form.quality_rating %}
                                            <div class="form-check mb-2">
                                                {{ choice.tag }}
                                                <label class="form-check-label" for="{{ choice.id_for_label }}">
                                                    {% for i in "12345"|make_list %}
                                                        {% if forloop.counter <= choice.choice_value %}
                                                            <i class="fas fa-star star-mini"></i>
                                                        {% else %}
                                                            <i class="far fa-star star-mini text-muted"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Punctuality Rating -->
                                <div class="col-12 col-md-4">
                                    <div class="detailed-rating-card">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="rating-icon-circle bg-info">
                                                <i class="fas fa-clock"></i>
                                            </div>
                                            <h6 class="mb-0 ms-3">Punctualitate</h6>
                                        </div>
                                        <div class="rating-options">
                                            {% for choice in form.punctuality_rating %}
                                            <div class="form-check mb-2">
                                                {{ choice.tag }}
                                                <label class="form-check-label" for="{{ choice.id_for_label }}">
                                                    {% for i in "12345"|make_list %}
                                                        {% if forloop.counter <= choice.choice_value %}
                                                            <i class="fas fa-star star-mini"></i>
                                                        {% else %}
                                                            <i class="far fa-star star-mini text-muted"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Communication Rating -->
                                <div class="col-12 col-md-4">
                                    <div class="detailed-rating-card">
                                        <div class="d-flex align-items-center mb-3">
                                            <div class="rating-icon-circle bg-success">
                                                <i class="fas fa-comments"></i>
                                            </div>
                                            <h6 class="mb-0 ms-3">Comunicare</h6>
                                        </div>
                                        <div class="rating-options">
                                            {% for choice in form.communication_rating %}
                                            <div class="form-check mb-2">
                                                {{ choice.tag }}
                                                <label class="form-check-label" for="{{ choice.id_for_label }}">
                                                    {% for i in "12345"|make_list %}
                                                        {% if forloop.counter <= choice.choice_value %}
                                                            <i class="fas fa-star star-mini"></i>
                                                        {% else %}
                                                            <i class="far fa-star star-mini text-muted"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                </label>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Comment Section -->
                        <div class="mb-5">
                            <h5 class="mb-4 rating-section-title">
                                <i class="fas fa-comment-alt me-2"></i>
                                Comentariu
                            </h5>
                            {{ form.comment }}
                            <div class="form-text mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Descrie experiența ta cu meșterul și calitatea lucrării
                            </div>
                        </div>

                        <!-- Image Upload Section -->
                        <div class="mb-5">
                            <h5 class="mb-4 rating-section-title">
                                <i class="fas fa-images me-2"></i>
                                Adaugă imagini (opțional)
                            </h5>
                            <div class="upload-area">
                                {{ image_form.images }}
                                <div class="form-text mt-2">
                                    <i class="fas fa-image me-1"></i>
                                    Poți adăuga imagini cu lucrarea finalizată (max 5MB per imagine)
                                </div>
                            </div>

                            {% if is_edit and existing_images %}
                            <div class="mt-3">
                                <small class="text-muted d-block mb-2">Imagini existente:</small>
                                <div class="row g-2">
                                    {% for image in existing_images %}
                                    <div class="col-6 col-sm-4 col-md-3">
                                        <img src="{{ image.image.url }}" alt="Review image" class="img-fluid rounded shadow-sm" style="height: 100px; width: 100%; object-fit: cover;">
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        </div>

                        <!-- Guidelines Box -->
                        <div class="alert alert-light border mb-4">
                            <h6 class="mb-3">
                                <i class="fas fa-lightbulb me-2" style="color: #8B5CF6;"></i>
                                Sfaturi pentru o recenzie utilă
                            </h6>
                            <ul class="mb-0 small text-muted">
                                <li class="mb-1">Fii onest și constructiv în comentariile tale</li>
                                <li class="mb-1">Descrie calitatea lucrării și experiența ta</li>
                                <li class="mb-1">Adaugă imagini cu lucrarea finalizată dacă este posibil</li>
                                <li class="mb-1">Respectă confidențialitatea și nu include informații personale</li>
                            </ul>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex flex-column flex-sm-row gap-3 justify-content-between">
                            <a href="{% if is_edit %}{% url 'services:review_detail' object.pk %}{% else %}{% url 'services:order_detail' order.pk %}{% endif %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>
                                {% if is_edit %}Renunță{% else %}Înapoi{% endif %}
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                <i class="fas fa-{% if is_edit %}save{% else %}star{% endif %} me-2"></i>
                                {% if is_edit %}Salvează modificările{% else %}Publică recenzia{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Modern Review Page Styles */
.review-header-icon {
    width: 80px;
    height: 80px;
    margin: 0 auto;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: pulse 2s ease-in-out infinite;
}

.review-header-icon i {
    font-size: 2.5rem;
    color: white;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.review-header-title {
    font-size: 2rem;
    font-weight: 700;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.review-form-card {
    border-radius: 16px;
    overflow: hidden;
}

.rating-section-title {
    color: #1f2937;
    font-weight: 600;
    font-size: 1.25rem;
}

.rating-section-title i {
    color: #8B5CF6;
}

/* Interactive Stars Container */
.interactive-stars-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.star-option {
    position: relative;
}

.star-option input[type="radio"] {
    position: absolute;
    opacity: 0;
    cursor: pointer;
}

.star-option-label {
    display: flex;
    align-items: center;
    padding: 1rem 1.5rem;
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    background: white;
}

.star-option-label:hover {
    border-color: #8B5CF6;
    background: #f3f4f6;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
}

.star-option input[type="radio"]:checked + .star-option-label {
    border-color: #8B5CF6;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.25);
}

.stars-display {
    display: flex;
    gap: 0.25rem;
}

.star-icon {
    font-size: 1.5rem;
    color: #8B5CF6;
    transition: all 0.2s ease;
}

.star-option:hover .star-icon {
    transform: scale(1.1);
}

.star-option input[type="radio"]:checked + .star-option-label .star-icon {
    animation: starPop 0.5s ease;
}

@keyframes starPop {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

.rating-text {
    margin-left: 1rem;
    font-weight: 500;
    color: #374151;
}

/* Detailed Rating Cards */
.detailed-rating-card {
    padding: 1.5rem;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    background: #f9fafb;
    height: 100%;
    transition: all 0.3s ease;
}

.detailed-rating-card:hover {
    border-color: #8B5CF6;
    background: white;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1);
}

.rating-icon-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
}

.rating-options .form-check {
    padding: 0.5rem;
    border-radius: 8px;
    transition: background 0.2s ease;
}

.rating-options .form-check:hover {
    background: white;
}

.rating-options .form-check-input {
    cursor: pointer;
    width: 1.25rem;
    height: 1.25rem;
    margin-top: 0.25rem;
}

.rating-options .form-check-input:checked {
    background-color: #8B5CF6;
    border-color: #8B5CF6;
}

.rating-options .form-check-label {
    cursor: pointer;
    margin-left: 0.5rem;
    display: inline-flex;
    gap: 0.1rem;
}

.star-mini {
    font-size: 0.875rem;
    color: #8B5CF6;
}

/* Textarea Styling */
#id_comment {
    border: 2px solid #e5e7eb;
    border-radius: 12px;
    padding: 1rem;
    min-height: 150px;
    font-size: 1rem;
    transition: all 0.3s ease;
}

#id_comment:focus {
    border-color: #8B5CF6;
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    outline: none;
}

/* Upload Area */
.upload-area {
    border: 2px dashed #e5e7eb;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    background: #f9fafb;
    transition: all 0.3s ease;
}

.upload-area:hover {
    border-color: #8B5CF6;
    background: #f3f4f6;
}

#id_images {
    padding: 0.75rem;
    border-radius: 8px;
    width: 100%;
    max-width: 400px;
}

/* Responsive Design */
@media (max-width: 768px) {
    .review-header-title {
        font-size: 1.5rem;
    }

    .review-header-icon {
        width: 60px;
        height: 60px;
    }

    .review-header-icon i {
        font-size: 2rem;
    }

    .star-option-label {
        flex-direction: column;
        text-align: center;
        padding: 1rem;
    }

    .rating-text {
        margin-left: 0;
        margin-top: 0.5rem;
    }

    .star-icon {
        font-size: 1.25rem;
    }
}

/* Button Enhancements */
.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(139, 92, 246, 0.3);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Enhanced star rating interaction with animations
    const starOptions = document.querySelectorAll('.star-option input[type="radio"]');

    starOptions.forEach(function(radio) {
        radio.addEventListener('change', function() {
            // Add selection animation
            const label = this.nextElementSibling;
            label.style.animation = 'none';
            setTimeout(() => {
                label.style.animation = 'starPop 0.5s ease';
            }, 10);
        });
    });

    // Character counter for comment
    const commentField = document.getElementById('id_comment');
    if (commentField) {
        commentField.addEventListener('input', function() {
            const length = this.value.length;
            const maxLength = 1000;
            console.log(`Characters: ${length}/${maxLength}`);
        });
    }

    // Form validation enhancement
    const form = document.getElementById('reviewForm');
    form.addEventListener('submit', function(e) {
        const ratingSelected = document.querySelector('.star-option input[type="radio"]:checked');
        if (!ratingSelected) {
            e.preventDefault();
            alert('Te rugăm să selectezi un rating general!');
            document.querySelector('.interactive-stars-container').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    });
});
</script>
{% endblock %}
