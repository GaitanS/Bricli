{% extends 'base.html' %}
{% load static %}

{% block title %}{% if is_edit %}Editează recenzia{% else %}Lasă o recenzie{% endif %} - {{ order.title }} - Bricli{% endblock %}

{% block content %}
<div class="container py-4 py-md-5">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10 col-xl-8">
            <!-- Modern Header with Gradient -->
            <div class="text-center mb-4 mb-md-5">
                <div class="review-header-icon mb-3">
                    <i class="fas fa-star"></i>
                </div>
                <h1 class="review-header-title mb-2">
                    {% if is_edit %}Editează Recenzia{% else %}Lasă o Recenzie{% endif %}
                </h1>
                <p class="text-muted">Spune-ne despre experiența ta cu {{ order.assigned_craftsman.user.get_full_name|default:order.assigned_craftsman.user.username }}</p>
            </div>

            <!-- Order Info Card - PERMANENT (alert-permanent class) -->
            <div class="alert alert-info alert-permanent border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <div class="row align-items-center g-3">
                    <div class="col-12 col-md-8">
                        <div class="d-flex align-items-start">
                            <i class="fas fa-clipboard-list fs-3 me-3 mt-1" style="opacity: 0.9;"></i>
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-bold" style="color: white;">{{ order.title }}</h6>
                                <small style="opacity: 0.9;">
                                    Meșter: <strong>{{ order.assigned_craftsman.user.get_full_name|default:order.assigned_craftsman.user.username }}</strong>
                                </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4 text-md-end">
                        <span class="badge bg-white text-dark px-3 py-2">
                            <i class="fas fa-check-circle text-success me-1"></i>
                            Comandă finalizată
                        </span>
                    </div>
                </div>
            </div>

            <!-- Main Form Card -->
            <div class="card border-0 shadow-sm review-form-card">
                <div class="card-body p-4 p-md-5">
                    <form method="post" enctype="multipart/form-data" id="reviewForm">
                        {% csrf_token %}

                        <!-- Overall Rating Section -->
                        <div class="mb-5">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0 rating-section-title">
                                    <i class="fas fa-star me-2"></i>
                                    Rating general <span class="text-danger">*</span>
                                </h5>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="ratingGuideBtn">
                                    <i class="fas fa-question-circle me-1"></i>
                                    Ajutor
                                </button>
                            </div>

                            <!-- Smart Help Banner -->
                            <div class="alert alert-info border-0 mb-4" id="smartGuideBanner" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-left: 4px solid #8B5CF6 !important;">
                                <div class="d-flex align-items-start">
                                    <i class="fas fa-lightbulb fs-4 me-3 mt-1" style="color: #8B5CF6;"></i>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-2" style="color: #1f2937; font-weight: 600;">
                                            Cum funcționează evaluarea?
                                        </h6>
                                        <p class="mb-2 small text-muted">
                                            <strong>Treci cu mouse-ul peste stele</strong> pentru a previzualiza ratingul, apoi <strong>click pentru a selecta</strong>. Poți evalua experiența ta de la 1 stea (nesatisfăcător) la 5 stele (excelent).
                                        </p>
                                        <button type="button" class="btn btn-sm btn-link p-0 text-decoration-none" id="dismissGuide" style="color: #8B5CF6; font-weight: 600;">
                                            Am înțeles <i class="fas fa-times ms-1"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Overall Rating with Hover Stars -->
                            <div class="overall-rating-container">
                                <div class="hover-star-rating overall-stars" data-rating-name="rating">
                                    {% for choice in form.rating %}
                                        {{ choice.tag }}
                                    {% endfor %}
                                    <div class="star-container-large">
                                        <i class="far fa-star hover-star-large" data-value="1"></i>
                                        <i class="far fa-star hover-star-large" data-value="2"></i>
                                        <i class="far fa-star hover-star-large" data-value="3"></i>
                                        <i class="far fa-star hover-star-large" data-value="4"></i>
                                        <i class="far fa-star hover-star-large" data-value="5"></i>
                                    </div>
                                </div>

                                <!-- Dynamic Rating Description -->
                                <div class="rating-description-container mt-4">
                                    <div class="rating-description" id="ratingDescription">
                                        <i class="fas fa-hand-pointer me-2" style="color: #8B5CF6;"></i>
                                        <span class="text-muted">Selectează un rating pentru a continua</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Ratings Section -->
                        <div class="mb-5">
                            <h5 class="mb-4 rating-section-title">
                                <i class="fas fa-chart-bar me-2"></i>
                                Evaluări detaliate (opțional)
                            </h5>

                            <!-- Quality Rating Row -->
                            <div class="detailed-rating-row mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="rating-icon-circle bg-primary">
                                        <i class="fas fa-check-circle"></i>
                                    </div>
                                    <h6 class="mb-0 ms-3 rating-label">Calitate lucrare</h6>
                                </div>
                                <div class="hover-star-rating" data-rating-name="quality_rating">
                                    {% for choice in form.quality_rating %}
                                        {{ choice.tag }}
                                    {% endfor %}
                                    <div class="star-container">
                                        <i class="far fa-star hover-star" data-value="1"></i>
                                        <i class="far fa-star hover-star" data-value="2"></i>
                                        <i class="far fa-star hover-star" data-value="3"></i>
                                        <i class="far fa-star hover-star" data-value="4"></i>
                                        <i class="far fa-star hover-star" data-value="5"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Punctuality Rating Row -->
                            <div class="detailed-rating-row mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="rating-icon-circle bg-info">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <h6 class="mb-0 ms-3 rating-label">Punctualitate</h6>
                                </div>
                                <div class="hover-star-rating" data-rating-name="punctuality_rating">
                                    {% for choice in form.punctuality_rating %}
                                        {{ choice.tag }}
                                    {% endfor %}
                                    <div class="star-container">
                                        <i class="far fa-star hover-star" data-value="1"></i>
                                        <i class="far fa-star hover-star" data-value="2"></i>
                                        <i class="far fa-star hover-star" data-value="3"></i>
                                        <i class="far fa-star hover-star" data-value="4"></i>
                                        <i class="far fa-star hover-star" data-value="5"></i>
                                    </div>
                                </div>
                            </div>

                            <!-- Communication Rating Row -->
                            <div class="detailed-rating-row mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="rating-icon-circle bg-success">
                                        <i class="fas fa-comments"></i>
                                    </div>
                                    <h6 class="mb-0 ms-3 rating-label">Comunicare</h6>
                                </div>
                                <div class="hover-star-rating" data-rating-name="communication_rating">
                                    {% for choice in form.communication_rating %}
                                        {{ choice.tag }}
                                    {% endfor %}
                                    <div class="star-container">
                                        <i class="far fa-star hover-star" data-value="1"></i>
                                        <i class="far fa-star hover-star" data-value="2"></i>
                                        <i class="far fa-star hover-star" data-value="3"></i>
                                        <i class="far fa-star hover-star" data-value="4"></i>
                                        <i class="far fa-star hover-star" data-value="5"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Comment Section -->
                        <div class="mb-5">
                            <h5 class="mb-4 rating-section-title">
                                <i class="fas fa-comment-alt me-2"></i>
                                Comentariu
                            </h5>
                            {{ form.comment }}
                            <div class="form-text mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Descrie experiența ta cu meșterul și calitatea lucrării
                            </div>
                        </div>

                        <!-- Image Upload Section -->
                        <div class="mb-5">
                            <h5 class="mb-4 rating-section-title">
                                <i class="fas fa-images me-2"></i>
                                Adaugă imagini (opțional)
                            </h5>

                            {% if is_edit and existing_images %}
                            <!-- Existing Images -->
                            <div class="existing-images-section mb-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="mb-0">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Imagini existente ({{ existing_images|length }})
                                    </h6>
                                    {% if remaining_images > 0 %}
                                    <small class="text-muted">
                                        Poți adăuga încă {{ remaining_images }} {{ remaining_images|pluralize:"imagine,imagini" }}
                                    </small>
                                    {% else %}
                                    <small class="text-warning">
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        Ai atins limita de 5 imagini
                                    </small>
                                    {% endif %}
                                </div>
                                <div class="existing-images-grid">
                                    {% for image in existing_images %}
                                    <div class="existing-image-card">
                                        <img src="{{ image.image.url }}" alt="Review image {{ forloop.counter }}" class="existing-image-thumb">
                                        <div class="existing-image-overlay">
                                            <i class="fas fa-check-circle"></i>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}

                            <!-- Upload Area -->
                            {% if not is_edit or remaining_images > 0 %}
                            <div class="modern-upload-area" id="uploadArea">
                                <input type="file"
                                       name="images"
                                       id="reviewImages"
                                       multiple
                                       accept="image/*"
                                       capture="camera"
                                       style="display: none;"
                                       {% if is_edit %}data-max="{{ remaining_images }}"{% else %}data-max="5"{% endif %}>

                                <label for="reviewImages" class="upload-trigger" id="uploadTrigger">
                                    <div class="upload-icon">
                                        <i class="fas fa-camera fa-3x mb-3"></i>
                                    </div>
                                    <h6 class="upload-title">Adaugă imagini cu lucrarea</h6>
                                    <p class="upload-subtitle text-muted">
                                        <i class="fas fa-mobile-alt me-1"></i> Camera sau fișiere
                                        <span class="mx-2">•</span>
                                        <i class="fas fa-image me-1"></i> {% if is_edit %}Max {{ remaining_images }}{% else %}Max 5{% endif %} imagini
                                        <span class="mx-2">•</span>
                                        <i class="fas fa-file-image me-1"></i> 5MB/imagine
                                    </p>
                                    <button type="button" class="btn btn-outline-primary btn-sm mt-2" onclick="document.getElementById('reviewImages').click(); return false;">
                                        <i class="fas fa-plus-circle me-2"></i>Selectează imagini
                                    </button>
                                </label>

                                <!-- Preview Container -->
                                <div id="imagePreviewContainer" class="image-preview-grid mt-4" style="display: none;"></div>

                                <!-- Upload Stats -->
                                <div id="uploadStats" class="upload-stats mt-3" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-primary" id="selectedCount">0 imagini selectate</span>
                                        <button type="button" class="btn btn-sm btn-link text-danger" id="clearAll">
                                            <i class="fas fa-trash me-1"></i>Șterge toate
                                        </button>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Help Text -->
                            <div class="form-text mt-3">
                                <i class="fas fa-info-circle me-1" style="color: #8B5CF6;"></i>
                                <strong>Sfat:</strong> Adaugă imagini clare cu lucrarea finalizată pentru a ajuta alți clienți.
                                Pe mobil poți face poze direct cu camera!
                            </div>
                        </div>

                        <!-- Guidelines Box -->
                        <div class="alert alert-light border mb-4">
                            <h6 class="mb-3">
                                <i class="fas fa-lightbulb me-2" style="color: #8B5CF6;"></i>
                                Sfaturi pentru o recenzie utilă
                            </h6>
                            <ul class="mb-0 small text-muted">
                                <li class="mb-1">Fii onest și constructiv în comentariile tale</li>
                                <li class="mb-1">Descrie calitatea lucrării și experiența ta</li>
                                <li class="mb-1">Adaugă imagini cu lucrarea finalizată dacă este posibil</li>
                                <li class="mb-1">Respectă confidențialitatea și nu include informații personale</li>
                            </ul>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex flex-column flex-sm-row gap-3 justify-content-between">
                            <a href="{% if is_edit %}{% url 'services:review_detail' object.pk %}{% else %}{% url 'services:order_detail' order.pk %}{% endif %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>
                                {% if is_edit %}Renunță{% else %}Înapoi{% endif %}
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg px-5">
                                <i class="fas fa-{% if is_edit %}save{% else %}star{% endif %} me-2"></i>
                                {% if is_edit %}Salvează modificările{% else %}Publică recenzia{% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="{% static 'css/pages/services/create_review.css' %}">

<script src="{% static 'js/pages/services/create_review.js' %}"></script>
{% endblock %}
