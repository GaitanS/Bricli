{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Postează o comandă - Bricli{% endblock %}

{% block extra_css %}
    {% load static %}
    <link href="{% static 'css/pages/services/create_order.css' %}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            {% if is_quote_request and craftsman %}
            <!-- Quote Request Header -->
            <div class="alert alert-info mb-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-1">
                            <i class="fas fa-handshake me-2"></i>Solicitare ofertă de la {{ craftsman.user.get_full_name|default:craftsman.user.username }}
                        </h5>
                        <p class="mb-0">Completează formularul pentru a solicita o ofertă personalizată de la acest meșter.</p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <a href="{% url 'accounts:craftsman_detail' craftsman.pk %}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-arrow-left me-2"></i>Înapoi la profil
                        </a>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Step Wizard -->
            <div class="step-wizard">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-title">Categorie</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-title">Locație</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-title">Detalii</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-title">{% if not is_authenticated %}Contact{% else %}Buget{% endif %}</div>
                </div>
                {% if not is_authenticated %}
                <div class="step" data-step="5">
                    <div class="step-number">5</div>
                    <div class="step-title">Finalizare</div>
                </div>
                {% endif %}
            </div>

            <div class="card shadow-lg border-0">
                <div class="card-body p-4">
                    <form method="post" id="orderForm" class="needs-live-validate" novalidate>
                        {% csrf_token %}

                        <!-- Step 1: Category & Service Selection (Two-Level) -->
                        <div class="step-content active" id="step-1">
                            {% if is_quote_request and craftsman_services %}
                                <!-- For craftsman quote requests, show services directly -->
                                <div class="text-center mb-4">
                                    <h3 class="fw-bold">Ce serviciu dorești de la {{ craftsman.user.get_full_name|default:craftsman.user.username }}?</h3>
                                    <p class="text-muted">Selectează din serviciile oferite de acest meșter</p>
                                </div>

                                <div class="category-grid" id="craftsman-services-grid">
                                    {% for craftsman_service in craftsman_services %}
                                    <div class="category-card" data-service="{{ craftsman_service.service.id }}" data-name="{{ craftsman_service.service.name }}">
                                        <i class="{{ craftsman_service.service.category.icon|default:'fas fa-tools' }}"></i>
                                        <p class="category-name">{{ craftsman_service.service.name }}</p>
                                        <small class="text-muted">{{ craftsman_service.service.category.name }}</small>
                                    </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <!-- For general orders, show category → service flow -->
                                <!-- Step 1a: Category Selection -->
                                <div id="category-selection">
                                    <div class="text-center mb-4">
                                        <h3 class="fw-bold">Ce categorie de serviciu cauți?</h3>
                                        <p class="text-muted">Selectează categoria care se potrivește nevoilor tale</p>
                                    </div>

                                    <div class="category-grid" id="categories-grid">
                                        {% for category in categories %}
                                        <div class="category-card" data-category-id="{{ category.id }}" data-category-name="{{ category.name }}">
                                            <i class="{{ category.icon|default:'fas fa-tools' }}"></i>
                                            <p class="category-name">{{ category.name }}</p>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- Step 1b: Service Selection (hidden initially) -->
                                <div id="service-selection" style="display: none;">
                                    <div class="text-center mb-4">
                                        <button type="button" class="btn btn-link text-decoration-none" id="backToCategoriesBtn">
                                            <i class="fas fa-arrow-left me-2"></i>Înapoi la categorii
                                        </button>
                                        <h3 class="fw-bold mt-2" id="selected-category-title">Selectează serviciul</h3>
                                        <p class="text-muted">Alege serviciul specific de care ai nevoie</p>
                                    </div>

                                    <div class="category-grid" id="services-grid">
                                        <!-- Services will be populated dynamically -->
                                    </div>
                                </div>
                            {% endif %}

                            <div class="d-flex justify-content-end mt-4">
                                <button type="button" class="btn btn-primary btn-lg" id="step1Next" disabled>
                                    Continuă <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 2: Location -->
                        <div class="step-content" id="step-2">
                            <div class="text-center mb-4">
                                <h3 class="fw-bold">Unde este localizată lucrarea?</h3>
                                <p class="text-muted">Selectează județul și orașul pentru a găsi meșteri din zona ta</p>
                            </div>

                            <div class="location-selector">
                                <div>
                                    <label for="{{ form.county.id_for_label }}" class="form-label fw-semibold">Județul *</label>
                                    {{ form.county }}
                                </div>
                                <div>
                                    <label for="{{ form.city.id_for_label }}" class="form-label fw-semibold">Orașul *</label>
                                    {{ form.city }}
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.address.id_for_label }}" class="form-label fw-semibold">
                                    Unde este localizată lucrarea? <span class="text-danger">*</span>
                                </label>
                                {{ form.address }}
                                <div class="form-text">Adresa exactă unde va avea loc lucrarea (strada, numărul, etajul, etc.)</div>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary btn-lg" id="step2Prev">
                                    <i class="fas fa-arrow-left me-2"></i>Înapoi
                                </button>
                                <button type="button" class="btn btn-primary btn-lg" id="step2Next" disabled>
                                    Continuă <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 3: Details -->
                        <div class="step-content" id="step-3">
                            <div class="text-center mb-4">
                                <h3 class="fw-bold">Descrie lucrarea în detaliu</h3>
                                <p class="text-muted">Cu cât mai multe detalii oferi, cu atât ofertele vor fi mai precise</p>
                            </div>

                            <div class="mb-4">
                                <label for="{{ form.title.id_for_label }}" class="form-label fw-semibold">Titlul comenzii *</label>
                                {{ form.title }}
                                <div class="form-text">Ex: Renovare baie completă, Instalare aer condiționat în living</div>
                            </div>

                            <div class="mb-4">
                                <label for="{{ form.description.id_for_label }}" class="form-label fw-semibold">Descrierea detaliată *</label>
                                {{ form.description }}
                                <div class="form-text">Descrie materialele necesare, dimensiunile, starea actuală, etc.</div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label fw-semibold">Cât de urgent este? *</label>
                                <div class="urgency-options">
                                    <div class="urgency-card" data-urgency="low">
                                        <i class="fas fa-clock text-success mb-2"></i>
                                        <h6>Flexibil</h6>
                                        <small class="text-muted">În următoarele săptămâni</small>
                                    </div>
                                    <div class="urgency-card" data-urgency="medium">
                                        <i class="fas fa-calendar text-warning mb-2"></i>
                                        <h6>Normal</h6>
                                        <small class="text-muted">În următoarele zile</small>
                                    </div>
                                    <div class="urgency-card" data-urgency="high">
                                        <i class="fas fa-exclamation-triangle text-danger mb-2"></i>
                                        <h6>Urgent</h6>
                                        <small class="text-muted">Cât mai repede</small>
                                    </div>
                                </div>
                            </div>



                            <div class="mb-4">
                                <label for="{{ form.preferred_date.id_for_label }}" class="form-label fw-semibold">Data preferată (opțional)</label>
                                <div class="input-group">
                                    {{ form.preferred_date }}
                                    <span class="input-group-text">
                                        <i class="fas fa-calendar-alt"></i>
                                    </span>
                                </div>
                                <div class="form-text">Selectează data când ai dori să înceapă lucrarea</div>
                            </div>

                            <!-- Photo Upload Section -->
                            <div class="mb-4">
                                <label class="form-label fw-semibold">Poze cu lucrarea (opțional)</label>
                                <div class="photo-upload-container">
                                    <div class="photo-upload-area" id="photo-upload-area">
                                        <div class="upload-placeholder">
                                            <i class="fas fa-camera fs-1 text-muted mb-3"></i>
                                            <h6 class="text-muted">Adaugă poze pentru o estimare mai precisă</h6>
                                            <p class="text-muted small mb-3">Poți adăuga până la 10 poze (JPG, PNG, max 5MB fiecare)</p>
                                            <button type="button" class="btn btn-outline-primary" id="add-photos-btn">
                                                <i class="fas fa-plus me-2"></i>Adaugă poze
                                            </button>
                                            <input type="file" id="photo-input" multiple accept="image/*" style="display: none;">
                                        </div>
                                    </div>
                                    <div class="photo-preview-container" id="photo-preview-container"></div>
                                </div>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Pozele ajută meșterii să înțeleagă mai bine lucrarea și să ofere prețuri mai precise
                                </div>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary btn-lg" id="step3Prev">
                                    <i class="fas fa-arrow-left me-2"></i>Înapoi
                                </button>
                                <button type="button" class="btn btn-primary btn-lg" id="step3Next" disabled>
                                    Continuă <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Step 4: Authentication (Anonymous Users Only) -->
                        {% if not is_authenticated %}
                        <div class="step-content" id="step-4">
                            <div class="text-center mb-4">
                                <h3 class="fw-bold">Detalii de Contact</h3>
                                <p class="text-muted">Introdu datele tale pentru a continua</p>
                            </div>

                            <div class="alert alert-info" id="existing-user-alert" style="display: none;">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Ai deja cont!</strong> Te rugăm să introduci parola pentru a continua.
                            </div>

                            <div class="alert alert-success" id="new-user-alert" style="display: none;">
                                <i class="fas fa-user-plus me-2"></i>
                                <strong>Creează cont nou</strong> - Introdu o parolă pentru a-ți securiza contul.
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="{{ form.user_name.id_for_label }}" class="form-label fw-semibold">
                                        Nume complet <span class="text-danger">*</span>
                                    </label>
                                    {{ form.user_name }}
                                    <div class="form-text">Ex: Ion Popescu</div>
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.user_email.id_for_label }}" class="form-label fw-semibold">
                                        Email <span class="text-danger">*</span>
                                    </label>
                                    {{ form.user_email }}
                                    <div class="form-text" id="email-check-message"></div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.user_phone.id_for_label }}" class="form-label fw-semibold">
                                    Telefon (opțional, dar recomandat)
                                </label>
                                {{ form.user_phone }}
                                <div class="form-text">Format: 0740123456 sau +40740123456</div>
                            </div>

                            <div class="row mb-3" id="password-fields">
                                <div class="col-md-6">
                                    <label for="{{ form.user_password.id_for_label }}" class="form-label fw-semibold">
                                        Parolă <span class="text-danger">*</span>
                                    </label>
                                    {{ form.user_password }}
                                    <div class="form-text">Minim 8 caractere</div>
                                </div>
                                <div class="col-md-6" id="password-confirm-field">
                                    <label for="{{ form.user_password_confirm.id_for_label }}" class="form-label fw-semibold">
                                        Confirmă Parola <span class="text-danger">*</span>
                                    </label>
                                    {{ form.user_password_confirm }}
                                </div>
                            </div>

                            <div class="mb-3" id="verification-method-field">
                                <label class="form-label fw-semibold">Primește codul de verificare pe:</label>
                                <div class="d-flex gap-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="verification_method" id="verify-email" value="email" checked>
                                        <label class="form-check-label" for="verify-email">
                                            <i class="fas fa-envelope me-1"></i> Email
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="verification_method" id="verify-whatsapp" value="whatsapp">
                                        <label class="form-check-label" for="verify-whatsapp">
                                            <i class="fab fa-whatsapp me-1"></i> WhatsApp
                                        </label>
                                    </div>
                                </div>
                                <div class="form-text">
                                    <i class="fas fa-shield-alt me-1"></i>
                                    Vei primi un cod de verificare pentru a-ți activa contul
                                </div>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary btn-lg" id="step4Prev">
                                    <i class="fas fa-arrow-left me-2"></i>Înapoi
                                </button>
                                <button type="button" class="btn btn-primary btn-lg" id="step4Next" disabled>
                                    Continuă <i class="fas fa-arrow-right ms-2"></i>
                                </button>
                            </div>
                        </div>
                        {% endif %}

                        <!-- Step 5 (or 4 for authenticated): Budget & Finalize -->
                        <div class="step-content" id="step-{% if not is_authenticated %}5{% else %}4{% endif %}">
                            <div class="text-center mb-4">
                                <h3 class="fw-bold">Care este bugetul tău?</h3>
                                <p class="text-muted">Stabilește o fourchette de preț pentru a primi oferte relevante</p>
                            </div>

                            <div class="budget-range">
                                <div>
                                    <label for="{{ form.budget_min.id_for_label }}" class="form-label fw-semibold">De la (RON)</label>
                                    {{ form.budget_min }}
                                </div>
                                <div class="text-center">
                                    <i class="fas fa-minus text-muted"></i>
                                </div>
                                <div>
                                    <label for="{{ form.budget_max.id_for_label }}" class="form-label fw-semibold">Până la (RON)</label>
                                    {{ form.budget_max }}
                                </div>
                            </div>

                            <div class="alert alert-info mt-4">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Sfat:</strong> Un buget realist te ajută să primești oferte mai precise și să eviți surprizele neplăcute.
                            </div>

                            <!-- Order Summary -->
                            <div class="card bg-light mt-4">
                                <div class="card-body">
                                    <h5 class="fw-bold mb-3">Rezumatul comenzii</h5>
                                    <div class="row">
                                        <div class="col-sm-4"><strong>Serviciu:</strong></div>
                                        <div class="col-sm-8" id="summary-service">-</div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-sm-4"><strong>Locație:</strong></div>
                                        <div class="col-sm-8" id="summary-location">-</div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-sm-4"><strong>Titlu:</strong></div>
                                        <div class="col-sm-8" id="summary-title">-</div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-sm-4"><strong>Urgență:</strong></div>
                                        <div class="col-sm-8" id="summary-urgency">-</div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between mt-4">
                                <button type="button" class="btn btn-outline-secondary btn-lg" id="step{% if not is_authenticated %}5{% else %}4{% endif %}Prev">
                                    <i class="fas fa-arrow-left me-2"></i>Înapoi
                                </button>
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-check me-2"></i>Postează comanda
                                </button>
                            </div>
                        </div>

                        <!-- Hidden form fields -->
                        <input type="hidden" name="service" id="selected-service">
                        <input type="hidden" name="urgency" id="selected-urgency">
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    window.createOrderConfig = {
        isAuthenticated: {{ is_authenticated|yesno:"true,false" }},
        servicesByCategory: {{ services_by_category_json|safe }},
        csrfToken: '{{ csrf_token }}',
        countyFieldId: '{{ form.county.id_for_label }}',
        cityFieldId: '{{ form.city.id_for_label }}',
        titleFieldId: '{{ form.title.id_for_label }}',
        descriptionFieldId: '{{ form.description.id_for_label }}',
        userEmailFieldId: '{{ form.user_email.id_for_label }}',
        userPhoneFieldId: '{{ form.user_phone.id_for_label }}',
        userNameFieldId: '{{ form.user_name.id_for_label }}',
        userPasswordFieldId: '{{ form.user_password.id_for_label }}',
        userPasswordConfirmFieldId: '{{ form.user_password_confirm.id_for_label }}'
    };
</script>
<script src="{% static 'js/pages/services/create_order.js' %}"></script>
{% endblock %}
