{% extends 'base.html' %}
{% load static %}

{% block title %}{{ order.title }} - Bricli{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/order-detail-responsive.css' %}">
<!-- Mobile Layout CSS -->
<link rel="stylesheet" href="{% static 'css/order-detail-mobile.css' %}">
<style>
    .order-image-thumbnail {
        transition: transform 0.2s ease-in-out;
    }

    .order-image-thumbnail:hover {
        transform: scale(1.05);
    }

    .client-details .reveal-phone {
        opacity: 0.7;
        transition: opacity 0.2s ease-in-out;
    }

    .client-details .reveal-phone:hover {
        opacity: 1;
    }

    .blurred-phone {
        font-family: monospace;
        letter-spacing: 1px;
    }

    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }

    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    }

    .client-details small {
        font-size: 0.875rem;
    }

    /* Quote Description Show More/Less Links - Force Visibility */
    .show-more-link,
    .show-less-link {
        display: block !important;
        margin-top: 1rem !important;  /* Increased from 0.5rem for better separation */
        margin-bottom: 0.5rem !important;
        color: #8B5CF6 !important;
        text-decoration: none !important;
        font-weight: 600 !important;
        font-size: 0.9rem !important;
        padding: 0.5rem 1rem !important;  /* Increased padding for larger click area */
        border-radius: 8px !important;
        border: 2px solid #8B5CF6 !important;  /* Thicker border for visibility */
        background: white !important;
        transition: all 0.2s ease !important;
        cursor: pointer !important;
        width: fit-content !important;
        position: relative !important;  /* Positioning context for z-index */
        z-index: 10 !important;  /* Ensure it's above all other content */
        pointer-events: auto !important;  /* Explicitly enable clicks */
        box-shadow: 0 2px 4px rgba(139, 92, 246, 0.1) !important;  /* Subtle shadow for depth */
    }

    .show-more-link:hover,
    .show-less-link:hover {
        background: #F3E8FF !important;
        color: #7C3AED !important;
        text-decoration: none !important;
        border-color: #7C3AED !important;
        box-shadow: 0 4px 8px rgba(139, 92, 246, 0.2) !important;  /* Enhanced shadow on hover */
        transform: translateY(-1px) !important;  /* Subtle lift effect */
    }

    /* Asigură că wrapper-ul nu ascunde butonul */
    .quote-description-wrapper {
        overflow: visible !important;
        position: relative !important;
        z-index: 1 !important;
    }

    .quote-description-short,
    .quote-description-full {
        overflow: visible !important;
        margin-bottom: 0 !important;  /* Remove bottom margin from paragraphs */
    }

    /* Ensure paragraph inside doesn't overlap - USE LINE CLAMP */
    .quote-description-short p {
        display: -webkit-box !important;
        -webkit-line-clamp: 3 !important;  /* Show maximum 3 lines */
        -webkit-box-orient: vertical !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        margin-bottom: 0 !important;
        line-height: 1.6 !important;  /* Consistent line height */
    }

    .quote-description-full p {
        margin-bottom: 0 !important;  /* Remove paragraph margin to prevent overlap */
    }

    /* Privacy Message - Force Static Visibility */
    .privacy-message-static {
        display: block !important;
        opacity: 1 !important;
        visibility: visible !important;
        position: relative !important;
        z-index: 5 !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<!-- Load Lightbox Script -->
{% if order.images.all %}
<script src="{% static 'js/lightbox.js' %}"></script>
{% endif %}

<!-- Mobile Layout JS -->
<script src="{% static 'js/order-detail-mobile.js' %}"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Phone number reveal functionality
    document.querySelectorAll('.reveal-phone').forEach(function(button) {
        button.addEventListener('click', function() {
            const phone = this.getAttribute('data-phone');
            const targetId = this.getAttribute('data-target');
            const target = document.getElementById(targetId);

            if (target) {
                target.textContent = phone;
                this.innerHTML = '<i class="fas fa-check"></i>';
                this.classList.remove('btn-outline-primary');
                this.classList.add('btn-success');
                this.disabled = true;
            }
        });
    });

    // Load More Quotes functionality
    const loadMoreBtn = document.getElementById('load-more-quotes');
    if (loadMoreBtn) {
        let currentVisible = 5;
        const quoteCards = document.querySelectorAll('.quote-card');
        const totalQuotes = quoteCards.length;

        loadMoreBtn.addEventListener('click', function() {
            const loadCount = 10; // Load 10 more at a time
            const endIndex = Math.min(currentVisible + loadCount, totalQuotes);

            // Show next batch of quotes with animation
            for (let i = currentVisible; i < endIndex; i++) {
                quoteCards[i].style.display = 'block';
                quoteCards[i].style.opacity = '0';
                quoteCards[i].style.transform = 'translateY(20px)';

                // Trigger animation
                setTimeout(() => {
                    quoteCards[i].style.transition = 'all 0.3s ease';
                    quoteCards[i].style.opacity = '1';
                    quoteCards[i].style.transform = 'translateY(0)';
                }, i * 50);
            }

            currentVisible = endIndex;

            // Update remaining count
            const remaining = totalQuotes - currentVisible;
            const remainingBadge = document.getElementById('remaining-quotes');
            if (remainingBadge) {
                remainingBadge.textContent = `(${remaining} rămase)`;
            }

            // Hide button if all quotes are shown
            if (currentVisible >= totalQuotes) {
                loadMoreBtn.style.display = 'none';
            }
        });
    }

    // Order Images Lightbox Initialization
    {% if order.images.all %}
    BricliLightbox.init('.order-image-thumbnail', {
        title: 'Imagini Comandă',
        showCaption: false,
        initGuardKey: 'orderImagesLightboxInit'
    });
    {% endif %}

    // Quote Description Expand/Collapse - Desktop
    // Use event delegation to handle both initial and dynamically loaded quotes
    document.addEventListener('click', function(e) {
        // Handle "Vezi mai mult" link (or clicks on its children like icons)
        const showMoreLink = e.target.closest('.show-more-link');
        if (showMoreLink) {
            e.preventDefault();
            const shortDesc = showMoreLink.closest('.quote-description-short');
            const fullDesc = shortDesc ? shortDesc.nextElementSibling : null;
            if (shortDesc && fullDesc && fullDesc.classList.contains('quote-description-full')) {
                shortDesc.style.display = 'none';
                fullDesc.style.display = 'block';
            }
        }

        // Handle "Vezi mai puțin" link (or clicks on its children like icons)
        const showLessLink = e.target.closest('.show-less-link');
        if (showLessLink) {
            e.preventDefault();
            const fullDesc = showLessLink.closest('.quote-description-full');
            const shortDesc = fullDesc ? fullDesc.previousElementSibling : null;
            if (fullDesc && shortDesc && shortDesc.classList.contains('quote-description-short')) {
                fullDesc.style.display = 'none';
                shortDesc.style.display = 'block';
            }
        }
    });
});
</script>
{% endblock %}

{% block content %}
<!-- ============================================
     MOBILE LAYOUT (OLX Style)
     ============================================ -->
<div class="mobile-layout">
    <!-- Image Carousel -->
    <div class="mobile-carousel">
        {% if order.images.all %}
            <div class="carousel-track">
                {% for image in order.images.all %}
                <img src="{{ image.image.url }}"
                     alt="Imagine comandă {{ forloop.counter }}"
                     class="carousel-image">
                {% endfor %}
            </div>

            <!-- Carousel Dots -->
            <div class="carousel-dots">
                {% for image in order.images.all %}
                <span class="carousel-dot {% if forloop.first %}active{% endif %}"></span>
                {% endfor %}
            </div>
        {% else %}
            <!-- Empty State -->
            <div class="carousel-empty">
                <i class="fas fa-hammer"></i>
                <p>{{ order.service.name|default:"Comandă" }}</p>
            </div>
        {% endif %}

        <!-- Back Button -->
        <button class="back-btn" onclick="window.history.back()">
            <i class="fas fa-arrow-left"></i>
        </button>
    </div>

    <!-- Order Header with Status -->
    <div class="mobile-order-header">
        <span class="status-badge
            {% if order.status == 'draft' %}bg-secondary
            {% elif order.status == 'published' %}bg-primary
            {% elif order.status == 'awaiting_confirmation' %}bg-warning
            {% elif order.status == 'in_progress' %}bg-info
            {% elif order.status == 'completed' %}bg-success
            {% elif order.status == 'cancelled' %}bg-danger
            {% endif %}">
            {{ order.get_status_display }}
        </span>
        <span class="time-badge">
            <i class="far fa-clock"></i>
            {{ order.created_at|timesince }} în urmă
        </span>
    </div>

    <!-- Title Section -->
    <div class="mobile-title-section">
        <h1 class="mobile-order-title">{{ order.title }}</h1>
        <div class="mobile-location">
            <i class="fas fa-map-marker-alt"></i>
            {{ order.city.name }}, {{ order.county.name }}
        </div>
    </div>

    <!-- Budget Card -->
    {% if order.budget_min or order.budget_max %}
    <div class="budget-card-mobile">
        <div class="budget-label">Buget estimat</div>
        <div class="budget-value">
            {% if order.budget_min and order.budget_max %}
                {{ order.budget_min }} - {{ order.budget_max }} RON
            {% elif order.budget_min %}
                De la {{ order.budget_min }} RON
            {% else %}
                Până la {{ order.budget_max }} RON
            {% endif %}
        </div>
        {% if order.urgency %}
        <span class="urgency-badge">
            <i class="fas fa-bolt"></i>
            {{ order.get_urgency_display }}
        </span>
        {% endif %}
    </div>
    {% endif %}

    <!-- Client Info Card -->
    <div class="client-card-mobile">
        <div class="client-header-mobile">
            {% if order.client.profile_picture %}
                <img src="{{ order.client.profile_picture.url }}"
                     alt="Client"
                     class="client-avatar-sm">
            {% else %}
                <div class="client-avatar-sm" style="background: #8B5CF6; color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 1.25rem;">
                    {{ order.client.first_name|first|default:order.client.username|first|upper }}
                </div>
            {% endif %}

            <div class="client-info-mobile">
                <div class="client-name-mobile">{{ order.client.get_full_name|default:order.client.username }}</div>
                <div class="client-meta-mobile">
                    <i class="fas fa-calendar-alt"></i>
                    Membru din {{ order.client.date_joined|date:"M Y" }}
                </div>
            </div>

            {% if order.client.is_verified %}
            <div class="verified-badge-mobile">
                <i class="fas fa-check"></i>
            </div>
            {% endif %}
        </div>

        {% if order.client.phone_number %}
        <button class="reveal-phone-btn" data-phone="{{ order.client.phone_number }}">
            <i class="fas fa-phone"></i>
            Arată numărul de telefon
        </button>
        {% endif %}
    </div>

    <div class="mobile-divider"></div>

    <!-- Collapsible: Description -->
    <div class="mobile-section">
        <button class="section-toggle">
            <span>Descriere</span>
            <i class="fas fa-chevron-down"></i>
        </button>
        <div class="section-content">
            {{ order.description }}
        </div>
    </div>

    <!-- Collapsible: Specifications -->
    <div class="mobile-section">
        <button class="section-toggle">
            <span>Specificații</span>
            <i class="fas fa-chevron-down"></i>
        </button>
        <div class="section-content">
            {% if order.service %}
            <div class="mb-2">
                <strong>Categorie:</strong> {{ order.service.name }}
            </div>
            {% endif %}

            {% if order.preferred_date %}
            <div class="mb-2">
                <strong>Data preferată:</strong> {{ order.preferred_date|date:"d.m.Y" }}
            </div>
            {% endif %}

            {% if order.address %}
            <div class="mb-2">
                <strong>Adresă:</strong> {{ order.address }}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Collapsible: Quotes -->
    {% if quotes %}
    <div class="mobile-section">
        <button class="section-toggle">
            <span>Oferte ({{ quotes.count }})</span>
            <i class="fas fa-chevron-down"></i>
        </button>
        <div class="section-content">
            {% for quote in quotes|slice:":5" %}
            <div class="quote-card-mobile">
                <div class="quote-header-mobile">
                    <a href="{% url 'accounts:craftsman_detail' slug=quote.craftsman.slug %}" style="text-decoration: none;">
                        {% if quote.craftsman.profile_photo %}
                            <img src="{{ quote.craftsman.profile_photo.url }}"
                                 alt="{{ quote.craftsman.user.get_full_name }}"
                                 class="quote-avatar-xs">
                        {% else %}
                            <div class="quote-avatar-xs" style="background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600;">
                                {{ quote.craftsman.user.get_full_name|first|default:quote.craftsman.user.username|first|upper }}
                            </div>
                        {% endif %}
                    </a>

                    <div class="quote-info-mobile">
                        <a href="{% url 'accounts:craftsman_detail' slug=quote.craftsman.slug %}" class="quote-craftsman-name" style="text-decoration: none; color: inherit;">
                            {{ quote.craftsman.user.get_full_name|default:quote.craftsman.user.username }}
                        </a>
                        {% if quote.craftsman.average_rating > 0 %}
                        <div class="rating-xs">
                            <i class="fas fa-star"></i>
                            {{ quote.craftsman.average_rating|floatformat:1 }}
                            <a href="{% url 'accounts:craftsman_detail' slug=quote.craftsman.slug %}#reviews"
                               style="color: inherit; text-decoration: none; transition: color 0.2s ease;"
                               onmouseover="this.style.color='#8B5CF6'; this.style.textDecoration='underline';"
                               onmouseout="this.style.color='inherit'; this.style.textDecoration='none';">
                                ({{ quote.craftsman.total_reviews }})
                            </a>
                        </div>
                        {% endif %}
                    </div>

                    <div class="quote-price-mobile">
                        {{ quote.price }} RON
                    </div>
                </div>

                <!-- Quote Description with expand/collapse - PRIVATE (only client and quote owner) -->
                {% if user == order.client or user == quote.craftsman.user %}
                    <div class="quote-description-mobile">
                        {% if quote.description|length > 100 %}
                            <p class="quote-desc-short-mobile">
                                {{ quote.description|truncatechars:100 }}
                                <a href="#" class="show-more-mobile" onclick="event.preventDefault(); this.parentElement.style.display='none'; this.parentElement.nextElementSibling.style.display='block';">
                                    Vezi tot
                                </a>
                            </p>
                            <p class="quote-desc-full-mobile" style="display: none;">
                                {{ quote.description }}
                                <a href="#" class="show-less-mobile" onclick="event.preventDefault(); this.parentElement.style.display='none'; this.parentElement.previousElementSibling.style.display='block';">
                                    Vezi mai puțin
                                </a>
                            </p>
                        {% else %}
                            <p class="quote-desc-short-mobile">{{ quote.description }}</p>
                        {% endif %}
                    </div>
                {% else %}
                    {# Other users see privacy message - STATIC/PERMANENT #}
                    <div class="privacy-message-static" style="padding: 0.75rem; background: #F3F4F6; border-left: 4px solid #9CA3AF; border-radius: 6px; margin-top: 0.5rem;">
                        <i class="fas fa-lock" style="color: #6B7280; margin-right: 0.5rem;"></i>
                        <small style="color: #4B5563; font-style: italic;">Descrierea ofertei este privată</small>
                    </div>
                {% endif %}

                {% if quote.estimated_duration %}
                <div style="margin-top: 0.5rem; color: #6b7280; font-size: 0.875rem;">
                    <i class="far fa-calendar-alt" style="color: #8B5CF6; margin-right: 0.25rem;"></i>
                    Durată: <strong>{{ quote.estimated_duration }}</strong>
                </div>
                {% endif %}

                {# Quote Attachments (Mobile) - PRIVATE (only client and quote owner) #}
                {% if user == order.client or user == quote.craftsman.user %}
                    {% if quote.attachments.all %}
                        <div style="margin-top: 0.75rem;">
                            {% for attachment in quote.attachments.all %}
                                <a href="{{ attachment.file.url }}"
                                   download
                                   style="display: flex; align-items: center; padding: 0.75rem; background: linear-gradient(135deg, #F3E8FF 0%, #E9D5FF 100%); border-radius: 8px; border-left: 4px solid #8B5CF6; text-decoration: none; margin-bottom: 0.5rem;">
                                    <div style="margin-right: 0.75rem;">
                                        {% if attachment.file_type == 'pdf' %}
                                            <i class="fas fa-file-pdf fa-lg" style="color: #DC2626;"></i>
                                        {% elif attachment.file_type == 'image' %}
                                            <i class="fas fa-file-image fa-lg" style="color: #8B5CF6;"></i>
                                        {% else %}
                                            <i class="fas fa-file fa-lg" style="color: #6B7280;"></i>
                                        {% endif %}
                                    </div>
                                    <div style="flex-grow: 1;">
                                        <div style="font-weight: 600; color: #5B21B6; font-size: 0.85rem;">
                                            {% if attachment.description %}
                                                {{ attachment.description }}
                                            {% else %}
                                                Ofertă PDF
                                            {% endif %}
                                        </div>
                                        <small style="color: #6B7280; font-size: 0.75rem;">
                                            {{ attachment.file_type|upper }}
                                            {% if attachment.file_size %} • {{ attachment.file_size|filesizeformat }}{% endif %}
                                        </small>
                                    </div>
                                    <i class="fas fa-download" style="color: #8B5CF6;"></i>
                                </a>
                            {% endfor %}
                        </div>
                    {% endif %}
                {% endif %}

                <div class="quote-actions-mobile">
                    {% if user == order.client and quote.status == 'pending' %}
                    <form method="post" action="{% url 'services:accept_quote' quote.pk %}" style="flex: 1;">
                        {% csrf_token %}
                        <button type="submit" class="btn-xs primary">
                            <i class="fas fa-check"></i> Acceptă
                        </button>
                    </form>
                    {% elif quote.status == 'accepted' %}
                    <span class="badge" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 0.5rem 1rem; border-radius: 20px; color: white;">
                        <i class="fas fa-check-circle"></i> Acceptată
                    </span>
                    {% elif quote.status == 'rejected' %}
                    <span class="badge" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); padding: 0.5rem 1rem; border-radius: 20px; color: white;">
                        <i class="fas fa-times-circle"></i> Respinsă
                    </span>
                    {% endif %}
                    <a href="{% url 'accounts:craftsman_detail' slug=quote.craftsman.slug %}" class="btn-xs secondary">
                        <i class="fas fa-user"></i> Profil
                    </a>
                </div>
            </div>
            {% endfor %}

            {% if quotes.count > 5 %}
            <div class="text-center mt-3">
                <small style="color: #6b7280;">+ {{ quotes.count|add:"-5" }} oferte disponibile</small>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <div class="mobile-divider"></div>

    <!-- Fixed Bottom Action Bar -->
    <div class="mobile-action-bar">
        {% if order.client.phone_number %}
        <a href="tel:{{ order.client.phone_number }}" class="action-btn-mobile secondary">
            <i class="fas fa-phone"></i>
            <span>Sună</span>
        </a>
        {% endif %}

        {% if can_quote %}
        <a href="{% url 'services:create_quote' order.pk %}" class="action-btn-mobile primary">
            <i class="fas fa-paper-plane"></i>
            <span>Trimite Ofertă</span>
        </a>
        {% elif user == order.client and order.status == 'published' %}
        <a href="{% url 'services:invite_craftsmen' order.pk %}" class="action-btn-mobile primary">
            <i class="fas fa-user-plus"></i>
            <span>Invită Meșteri</span>
        </a>
        {% endif %}
    </div>
</div>

<!-- ============================================
     DESKTOP LAYOUT (Original)
     ============================================ -->
<div class="desktop-layout">
<div class="container mt-4">
    <div class="order-header">
        <h1 class="order-title">{{ order.title }}</h1>

        <!-- Mesaj pentru client când a trimis solicitare personală -->
        {% if user == order.client and order.assigned_craftsman and order.status in 'draft,published' %}
        <div class="alert-compact alert-info">
            <i class="fas fa-info-circle"></i>
            <div class="alert-content">
                <strong>Solicitare personală</strong> trimisă către
                <a href="{% url 'accounts:craftsman_detail' order.assigned_craftsman.pk %}" class="alert-link text-truncate-mobile">
                    {{ order.assigned_craftsman.display_name|default:order.assigned_craftsman.user.get_full_name|truncatechars:35 }}
                </a>.
                <span class="d-block d-sm-inline">Doar acest meșter poate vedea și oferta pentru această comandă.</span>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                        <h5>Detalii Comandă</h5>
                        <!-- Badge pentru solicitare personală -->
                        {% if order.assigned_craftsman and order.status in 'draft,published' %}
                        <span class="badge-personal">
                            <i class="fas fa-user-check"></i>
                            <span class="badge-text">Solicitare Personală</span>
                        </span>
                        {% endif %}
                    </div>

                    <div class="order-field">
                        <label class="field-label">Descriere</label>
                        <div class="field-value">{{ order.description }}</div>
                    </div>
                    <div class="order-field">
                        <label class="field-label">Status</label>
                        <div class="field-value">
                            <span class="badge
                                {% if order.status == 'draft' %}bg-secondary
                                {% elif order.status == 'published' %}bg-primary
                                {% elif order.status == 'awaiting_confirmation' %}bg-warning
                                {% elif order.status == 'in_progress' %}bg-info
                                {% elif order.status == 'completed' %}bg-success
                                {% elif order.status == 'cancelled' %}bg-danger
                                {% endif %}">
                                {{ order.get_status_display }}
                            </span>
                        </div>
                    </div>

                    <div class="order-field">
                        <label class="field-label">Locație</label>
                        <div class="field-value text-break-word">
                            {% if order.address %}
                                {{ order.address }}, {{ order.city.name }}, {{ order.county.name }}
                            {% else %}
                                {{ order.city.name }}, {{ order.county.name }}
                            {% endif %}
                        </div>
                    </div>

                    {% if order.service %}
                    <div class="order-field">
                        <label class="field-label">Categorie serviciu</label>
                        <div class="field-value">{{ order.service.name }}</div>
                    </div>
                    {% endif %}

                    {% if order.urgency %}
                    <div class="order-field">
                        <label class="field-label">Urgență</label>
                        <div class="field-value">
                            <span class="badge
                                {% if order.urgency == 'low' %}bg-success
                                {% elif order.urgency == 'medium' %}bg-warning
                                {% elif order.urgency == 'high' %}bg-danger
                                {% endif %}">
                                {{ order.get_urgency_display }}
                            </span>
                        </div>
                    </div>
                    {% endif %}

                    {% if order.preferred_date %}
                    <div class="order-field">
                        <label class="field-label">Data preferată</label>
                        <div class="field-value">{{ order.preferred_date|date:"d.m.Y" }}</div>
                    </div>
                    {% endif %}

                    {% if user.user_type == 'craftsman' %}
                        {% if order.assigned_craftsman == user.craftsman_profile and order.status in 'draft,published' %}
                            <!-- Alert pentru solicitare personală -->
                            <div class="mt-3">
                                <div class="alert" style="background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%); border-left: 4px solid #8B5CF6; border: none;">
                                    <div class="d-flex align-items-start">
                                        <i class="fas fa-star fa-2x me-3" style="color: #8B5CF6;"></i>
                                        <div>
                                            <h6 class="fw-bold mb-2" style="color: #5b21b6;">
                                                Solicitare Personală de Ofertă
                                            </h6>
                                            <p class="mb-2" style="color: #6b21a8;">
                                                Clientul <strong>{{ order.client.get_full_name|default:order.client.username }}</strong>
                                                te-a ales special pentru această lucrare. Această comandă este vizibilă doar pentru tine.
                                            </p>
                                            <small class="text-muted">
                                                <i class="fas fa-lock me-1"></i>Comandă privată - nu apare în lista publică
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% elif invitation %}
                            <div class="mt-3">
                                {% if invitation.status == 'pending' %}
                                    <div class="alert alert-primary">
                                        <i class="fas fa-handshake me-2"></i>Ai fost invitat de client să ofertezi pentru această lucrare publică.
                                    </div>
                                {% elif invitation.status == 'accepted' %}
                                    <div class="alert alert-success">
                                        <i class="fas fa-check-circle me-2"></i>Invitația este acceptată. Trimite oferta ta!
                                    </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endif %}
                    
                    {% if order.budget_min or order.budget_max %}
                    <div class="order-field">
                        <label class="field-label">Buget</label>
                        <div class="field-value">
                            {% if order.budget_min and order.budget_max %}
                                {{ order.budget_min }} - {{ order.budget_max }} RON
                            {% elif order.budget_min %}
                                De la {{ order.budget_min }} RON
                            {% else %}
                                Până la {{ order.budget_max }} RON
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if order.assigned_craftsman %}
                    <div class="order-field">
                        <label class="field-label">Meșter asignat</label>
                        <div class="field-value">
                            <div class="text-break-word">{{ order.assigned_craftsman.user.get_full_name|default:order.assigned_craftsman.user.username }}</div>
                            {% if order.assigned_craftsman.average_rating > 0 %}
                                <small class="text-muted">
                                    <i class="fas fa-star text-warning"></i> {{ order.assigned_craftsman.average_rating|floatformat:1 }}
                                    <a href="{% url 'accounts:craftsman_detail' slug=order.assigned_craftsman.slug %}#reviews"
                                       style="color: #6b7280; text-decoration: none; transition: color 0.2s ease;"
                                       onmouseover="this.style.color='#8B5CF6'; this.style.textDecoration='underline';"
                                       onmouseout="this.style.color='#6b7280'; this.style.textDecoration='none';">
                                        ({{ order.assigned_craftsman.total_reviews }} recenzii)
                                    </a>
                                </small>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- Craftsman confirmation buttons -->
                    {% if user.user_type == 'craftsman' and order.assigned_craftsman == user.craftsman_profile and order.status == 'awaiting_confirmation' %}
                    <div class="alert alert-warning alert-permanent">
                        <h6><i class="fas fa-exclamation-triangle me-2"></i>Confirmare necesară</h6>
                        <p class="mb-3">Clientul a acceptat oferta ta! Te rugăm să confirmi că poți prelua această comandă.</p>
                        <div class="d-flex gap-2">
                            <form method="post" action="{% url 'services:confirm_order' order.pk %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-check me-2"></i>Confirm preluarea
                                </button>
                            </form>
                            <form method="post" action="{% url 'services:decline_order' order.pk %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Ești sigur că vrei să refuzi această comandă?')">
                                    <i class="fas fa-times me-2"></i>Nu pot prelua
                                </button>
                            </form>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Client status information -->
                    {% if user == order.client and order.status == 'awaiting_confirmation' %}
                    <div class="alert alert-info">
                        <h6><i class="fas fa-clock me-2"></i>Așteaptă confirmarea meșterului</h6>
                        <p class="mb-0">Meșterul {{ order.assigned_craftsman.user.get_full_name|default:order.assigned_craftsman.user.username }} a fost notificat și va confirma în curând dacă poate prelua comanda.</p>
                    </div>
                    {% endif %}

                    <!-- Craftsman: Order in progress - complete button -->
                    {% if user.user_type == 'craftsman' and order.assigned_craftsman == user.craftsman_profile and order.status == 'in_progress' %}
                    <div class="alert alert-info alert-permanent">
                        <h6><i class="fas fa-tools me-2"></i>Lucrare în desfășurare</h6>
                        <p class="mb-3">Comanda este în curs de execuție. Când ai terminat lucrarea, marchează-o ca finalizată.</p>
                        <form method="post" action="{% url 'services:complete_order' order.pk %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-success" onclick="return confirm('Ești sigur că ai finalizat lucrarea? Clientul va fi notificat și va putea lăsa o recenzie.')">
                                <i class="fas fa-check-circle me-2"></i>Marchează ca Finalizată
                            </button>
                        </form>
                    </div>
                    {% endif %}

                    <!-- Client: Order in progress - info -->
                    {% if user == order.client and order.status == 'in_progress' %}
                    <div class="alert alert-success alert-permanent">
                        <h6><i class="fas fa-hammer me-2"></i>Lucrare în desfășurare</h6>
                        <p class="mb-2">Meșterul {{ order.assigned_craftsman.user.get_full_name|default:order.assigned_craftsman.user.username }} lucrează la comanda ta.</p>
                        <div class="mt-3">
                            <strong><i class="fas fa-phone me-2"></i>Contact direct:</strong><br>
                            {% if order.assigned_craftsman.user.phone_number %}
                                <a href="tel:{{ order.assigned_craftsman.user.phone_number }}" class="btn btn-sm btn-primary me-2 mt-2">
                                    <i class="fas fa-phone"></i> {{ order.assigned_craftsman.user.phone_number }}
                                </a>
                            {% endif %}
                            <a href="mailto:{{ order.assigned_craftsman.user.email }}" class="btn btn-sm btn-outline-primary mt-2">
                                <i class="fas fa-envelope"></i> Trimite Email
                            </a>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Client: Order completed - review prompt -->
                    {% if user == order.client and order.status == 'completed' %}
                        {% if not order.review %}
                        <div class="alert alert-warning alert-permanent">
                            <h6><i class="fas fa-star me-2"></i>Lucrarea a fost finalizată!</h6>
                            <p class="mb-3">Meșterul {{ order.assigned_craftsman.user.get_full_name|default:order.assigned_craftsman.user.username }} a marcat comanda ca finalizată. Te rugăm să lași o recenzie despre calitatea serviciului.</p>
                            <a href="{% url 'services:create_review' order.pk %}" class="btn btn-warning">
                                <i class="fas fa-star me-2"></i>Lasă o Recenzie
                            </a>
                        </div>
                        {% else %}
                        <div class="alert alert-success alert-permanent">
                            <h6><i class="fas fa-check-circle me-2"></i>Comandă finalizată</h6>
                            <p class="mb-2">Lucrarea a fost finalizată și ai lăsat deja o recenzie. Mulțumim!</p>
                            <a href="{% url 'services:review_detail' order.review.pk %}" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-eye me-2"></i>Vezi Recenzia
                            </a>
                        </div>
                        {% endif %}
                    {% endif %}

                    <!-- Craftsman: Order completed - show disabled button -->
                    {% if user.user_type == 'craftsman' and order.assigned_craftsman == user.craftsman_profile and order.status == 'completed' %}
                    <button class="btn btn-secondary w-100" disabled title="Comanda a fost finalizată">
                        <i class="fas fa-lock me-2"></i>Comandă finalizată
                    </button>

                    <small class="text-muted d-block mt-2">
                        <i class="fas fa-info-circle me-1"></i>Comanda a fost finalizată. Clientul poate lăsa o recenzie.
                    </small>
                    {% endif %}
                </div>
            </div>

            <!-- Order Images Section -->
            {% if order.images.all %}
            <div class="card mt-4">
                <div class="card-body">
                    <h5><i class="fas fa-images me-2"></i>Imagini comandă ({{ order.images.count }})</h5>
                    <div class="row g-3">
                        {% for image in order.images.all %}
                        <div class="col-md-4 col-sm-6">
                            <div class="position-relative">
                                <img src="{{ image.image.url }}"
                                     alt="Imagine comandă"
                                     class="img-fluid rounded shadow-sm order-image-thumbnail"
                                     style="width: 100%; height: 200px; object-fit: cover; cursor: pointer;"
                                     data-image-index="{{ forloop.counter0 }}">
                                <div class="position-absolute top-0 end-0 m-2">
                                    <span class="badge bg-dark bg-opacity-75">{{ forloop.counter }}/{{ order.images.count }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Quotes Section -->
            <div class="card mt-4" style="border: none; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);">
                <div class="card-body">
                    <h5 class="mb-4" style="color: #1f2937;">
                        <i class="fas fa-file-invoice" style="color: #8B5CF6;"></i>
                        Oferte ({{ quotes.count }})
                    </h5>

                    {% if quotes %}
                        <div id="quotes-container">
                            {% for quote in quotes %}
                            <div class="quote-card mb-3" data-quote-index="{{ forloop.counter0 }}" style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 1.5rem; transition: all 0.3s ease; {% if forloop.counter0 >= 5 %}display: none;{% endif %}">
                                <div class="row">
                                    <!-- Craftsman Info Column -->
                                    <div class="col-md-8">
                                        <div class="d-flex align-items-start mb-3">
                                            <!-- Avatar -->
                                            <a href="{% url 'accounts:craftsman_detail' slug=quote.craftsman.slug %}" class="me-3" style="text-decoration: none; cursor: pointer;">
                                                {% if quote.craftsman.profile_photo %}
                                                    <img src="{{ quote.craftsman.profile_photo.url }}"
                                                         alt="{{ quote.craftsman.user.get_full_name }}"
                                                         class="rounded-circle"
                                                         style="width: 50px; height: 50px; object-fit: cover; border: 2px solid #8B5CF6; transition: transform 0.2s ease;"
                                                         onmouseover="this.style.transform='scale(1.05)'"
                                                         onmouseout="this.style.transform='scale(1)'">
                                                {% else %}
                                                    <div class="rounded-circle bg-gradient d-flex align-items-center justify-content-center text-white"
                                                         style="width: 50px; height: 50px; background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); font-size: 1.25rem; font-weight: 600; transition: transform 0.2s ease;"
                                                         onmouseover="this.style.transform='scale(1.05)'"
                                                         onmouseout="this.style.transform='scale(1)'">
                                                        {{ quote.craftsman.user.get_full_name|first|default:quote.craftsman.user.username|first|upper }}
                                                    </div>
                                                {% endif %}
                                            </a>

                                            <!-- Name and Rating -->
                                            <div class="flex-grow-1">
                                                <div class="d-flex align-items-center mb-2">
                                                    <h6 class="mb-0 me-2" style="color: #1f2937; font-weight: 600;">
                                                        <a href="{% url 'accounts:craftsman_detail' slug=quote.craftsman.slug %}"
                                                           style="color: #1f2937; text-decoration: none; transition: color 0.2s ease;"
                                                           onmouseover="this.style.color='#8B5CF6'; this.style.textDecoration='underline'"
                                                           onmouseout="this.style.color='#1f2937'; this.style.textDecoration='none'">
                                                            {{ quote.craftsman.user.get_full_name|default:quote.craftsman.user.username }}
                                                        </a>
                                                    </h6>
                                                    {% if quote.craftsman.average_rating > 0 %}
                                                        <div class="d-flex align-items-center">
                                                            {% for i in "12345" %}
                                                                {% if forloop.counter <= quote.craftsman.average_rating %}
                                                                    <i class="fas fa-star" style="color: #8B5CF6; font-size: 0.85rem;"></i>
                                                                {% else %}
                                                                    <i class="far fa-star" style="color: #d1d5db; font-size: 0.85rem;"></i>
                                                                {% endif %}
                                                            {% endfor %}
                                                            <span style="color: #6b7280; font-size: 0.875rem; margin-left: 0.5rem;">
                                                                {{ quote.craftsman.average_rating|floatformat:1 }}
                                                                <a href="{% url 'accounts:craftsman_detail' slug=quote.craftsman.slug %}#reviews"
                                                                   style="color: #6b7280; text-decoration: none; transition: color 0.2s ease;"
                                                                   onmouseover="this.style.color='#8B5CF6'; this.style.textDecoration='underline';"
                                                                   onmouseout="this.style.color='#6b7280'; this.style.textDecoration='none';">
                                                                    ({{ quote.craftsman.total_reviews }} recenzii)
                                                                </a>
                                                            </span>
                                                        </div>
                                                    {% endif %}
                                                </div>

                                                <!-- Description with truncation - PRIVATE (only client and quote owner) -->
                                                {% if user == order.client or user == quote.craftsman.user %}
                                                    <div class="quote-description-wrapper" style="overflow-wrap: break-word; word-wrap: break-word; word-break: break-word;">
                                                        {% if quote.description|length > 150 %}
                                                            <div class="quote-description-short">
                                                                <p class="mb-1" style="color: #4b5563; line-height: 1.6; overflow-wrap: break-word; word-wrap: break-word; word-break: break-word;">
                                                                    {{ quote.description|truncatechars:150 }}
                                                                </p>
                                                                <a href="#" class="show-more-link">
                                                                    <i class="fas fa-chevron-down me-1"></i>Vezi tot
                                                                </a>
                                                            </div>
                                                            <div class="quote-description-full" style="display: none;">
                                                                <p class="mb-1" style="color: #4b5563; line-height: 1.6; overflow-wrap: break-word; word-wrap: break-word; word-break: break-word;">
                                                                    {{ quote.description }}
                                                                </p>
                                                                <a href="#" class="show-less-link">
                                                                    <i class="fas fa-chevron-up me-1"></i>Ascunde
                                                                </a>
                                                            </div>
                                                        {% else %}
                                                            <p class="mb-2" style="color: #4b5563; line-height: 1.6; overflow-wrap: break-word; word-wrap: break-word; word-break: break-word;">{{ quote.description }}</p>
                                                        {% endif %}
                                                    </div>
                                                {% else %}
                                                    {# Other users see privacy message - STATIC/PERMANENT #}
                                                    <div class="alert alert-sm mb-2 privacy-message-static" style="background: #F3F4F6; border-left: 4px solid #9CA3AF; padding: 0.75rem; border-radius: 6px;">
                                                        <i class="fas fa-lock me-2" style="color: #6B7280;"></i>
                                                        <small style="color: #4B5563; font-style: italic;">Descrierea ofertei este privată</small>
                                                    </div>
                                                {% endif %}

                                                {% if quote.estimated_duration %}
                                                    <div class="d-flex align-items-center" style="color: #6b7280; font-size: 0.875rem;">
                                                        <i class="far fa-calendar-alt me-2" style="color: #8B5CF6;"></i>
                                                        Durată estimată: <strong class="ms-1">{{ quote.estimated_duration }}</strong>
                                                    </div>
                                                {% endif %}

                                                {# Quote Attachments (PDF) - PRIVATE (only client and quote owner) #}
                                                {% if user == order.client or user == quote.craftsman.user %}
                                                    {% if quote.attachments.all %}
                                                        <div class="mt-3">
                                                            {% for attachment in quote.attachments.all %}
                                                                <div class="d-flex align-items-center p-3 mb-2" style="background: linear-gradient(135deg, #F3E8FF 0%, #E9D5FF 100%); border-radius: 8px; border-left: 4px solid #8B5CF6;">
                                                                    <div class="me-3">
                                                                        {% if attachment.file_type == 'pdf' %}
                                                                            <i class="fas fa-file-pdf fa-2x" style="color: #DC2626;"></i>
                                                                        {% elif attachment.file_type == 'image' %}
                                                                            <i class="fas fa-file-image fa-2x" style="color: #8B5CF6;"></i>
                                                                        {% else %}
                                                                            <i class="fas fa-file fa-2x" style="color: #6B7280;"></i>
                                                                        {% endif %}
                                                                    </div>
                                                                    <div class="flex-grow-1">
                                                                        <div style="font-weight: 600; color: #5B21B6; font-size: 0.9rem;">
                                                                            {% if attachment.description %}
                                                                                {{ attachment.description }}
                                                                            {% else %}
                                                                                Ofertă atașată
                                                                            {% endif %}
                                                                        </div>
                                                                        <small style="color: #6B7280;">
                                                                            {{ attachment.file_type|upper }} •
                                                                            {% if attachment.file_size %}
                                                                                {{ attachment.file_size|filesizeformat }}
                                                                            {% endif %}
                                                                        </small>
                                                                    </div>
                                                                    <a href="{{ attachment.file.url }}"
                                                                       download
                                                                       class="btn btn-sm"
                                                                       style="background: white; border: 2px solid #8B5CF6; color: #8B5CF6; font-weight: 600;"
                                                                       onmouseover="this.style.background='#8B5CF6'; this.style.color='white';"
                                                                       onmouseout="this.style.background='white'; this.style.color='#8B5CF6';">
                                                                        <i class="fas fa-download me-1"></i>Descarcă
                                                                    </a>
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Price and Status Column -->
                                    <div class="col-md-4 text-md-end">
                                        <div class="h3 mb-2" style="color: #8B5CF6; font-weight: 700;">
                                            {{ quote.price }} <span style="font-size: 1rem; color: #6b7280;">RON</span>
                                        </div>
                                        <div class="mb-3">
                                            {% if quote.status == 'accepted' %}
                                                <span class="badge" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 0.5rem 1rem; border-radius: 20px;">
                                                    <i class="fas fa-check-circle me-1"></i>{{ quote.get_status_display }}
                                                </span>
                                            {% elif quote.status == 'rejected' %}
                                                <span class="badge" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); padding: 0.5rem 1rem; border-radius: 20px;">
                                                    <i class="fas fa-times-circle me-1"></i>{{ quote.get_status_display }}
                                                </span>
                                            {% else %}
                                                <span class="badge" style="background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); padding: 0.5rem 1rem; border-radius: 20px;">
                                                    <i class="fas fa-clock me-1"></i>{{ quote.get_status_display }}
                                                </span>
                                            {% endif %}
                                        </div>
                                        <small style="color: #9ca3af; font-size: 0.875rem;">
                                            <i class="far fa-clock me-1"></i>{{ quote.created_at|date:"d.m.Y" }}
                                        </small>
                                    </div>
                                </div>

                                {% if user == order.client %}
                                    <!-- Check if craftsman is shortlisted -->
                                    {% with shortlist=quote.craftsman.user.shortlisted_for.all|first %}
                                        {% if shortlist and shortlist.order == order %}
                                            <div class="mt-3 p-3" style="background: linear-gradient(135deg, #10b98120 0%, #05966920 100%); border-left: 4px solid #10b981; border-radius: 8px;">
                                                <i class="fas fa-check-circle me-2" style="color: #10b981;"></i>
                                                <strong style="color: #065f46;">Shortlistat!</strong>
                                                <span style="color: #047857;"> - Contactul este disponibil</span>
                                                <div class="mt-2">
                                                    <strong style="color: #065f46;">Contact:</strong>
                                                    {% if quote.craftsman.user.phone %}
                                                        <a href="tel:{{ quote.craftsman.user.phone }}" class="btn btn-sm me-2" style="background: white; border: 1px solid #8B5CF6; color: #8B5CF6;">
                                                            <i class="fas fa-phone"></i> {{ quote.craftsman.user.phone }}
                                                        </a>
                                                    {% endif %}
                                                    <a href="mailto:{{ quote.craftsman.user.email }}" class="btn btn-sm" style="background: white; border: 1px solid #8B5CF6; color: #8B5CF6;">
                                                        <i class="fas fa-envelope"></i> Email
                                                    </a>
                                                </div>
                                            </div>
                                        {% elif quote.status == 'pending' %}
                                            <div class="quote-actions">
                                                <form method="post" action="{% url 'services:shortlist_craftsman' order.pk quote.craftsman.user.pk %}" style="flex: 1 1 auto;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn-action btn-primary w-100">
                                                        <i class="fas fa-star me-1"></i>Shortlistează (20 lei)
                                                    </button>
                                                </form>
                                                <form method="post" action="{% url 'services:accept_quote' quote.pk %}" style="flex: 1 1 auto;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn-action btn-success w-100">
                                                        <i class="fas fa-check me-1"></i>Acceptă Direct
                                                    </button>
                                                </form>
                                                <form method="post" action="{% url 'services:reject_quote' quote.pk %}" style="flex: 1 1 auto;">
                                                    {% csrf_token %}
                                                    <button type="submit" class="btn-action btn-outline-danger w-100">
                                                        <i class="fas fa-times me-1"></i>Respinge
                                                    </button>
                                                </form>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                {% elif user.user_type == 'craftsman' and user == quote.craftsman.user %}
                                    <!-- Show status for craftsman's own quote -->
                                    <div class="mt-3">
                                        <!-- Show if shortlisted -->
                                        {% with shortlist=user.shortlisted_for.all|first %}
                                            {% if shortlist and shortlist.order == order %}
                                                <div class="p-3" style="background: linear-gradient(135deg, #8B5CF620 0%, #7C3AED20 100%); border-left: 4px solid #8B5CF6; border-radius: 8px;">
                                                    <span style="color: #7C3AED; font-weight: 600;">
                                                        <i class="fas fa-star me-1"></i>Shortlistat
                                                    </span>
                                                    <div class="mt-2">
                                                        <strong style="color: #5B21B6;">Contact client:</strong>
                                                        {% if order.client.phone %}
                                                            <a href="tel:{{ order.client.phone }}" class="btn btn-sm me-2" style="background: white; border: 1px solid #8B5CF6; color: #8B5CF6;">
                                                                <i class="fas fa-phone"></i> {{ order.client.phone }}
                                                            </a>
                                                        {% endif %}
                                                        <a href="mailto:{{ order.client.email }}" class="btn btn-sm" style="background: white; border: 1px solid #8B5CF6; color: #8B5CF6;">
                                                            <i class="fas fa-envelope"></i> Email
                                                        </a>
                                                    </div>
                                                </div>
                                            {% endif %}
                                        {% endwith %}
                                    </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Load More Button -->
                        {% if quotes.count > 5 %}
                        <div class="text-center mt-4">
                            <button id="load-more-quotes" class="btn" style="background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); color: white; border: none; padding: 0.75rem 2rem; border-radius: 25px; font-weight: 600; transition: all 0.3s ease;">
                                <i class="fas fa-chevron-down me-2"></i>Încarcă mai multe
                                <span id="remaining-quotes" class="ms-2 badge bg-white" style="color: #8B5CF6;">({{ quotes.count|add:"-5" }} rămase)</span>
                            </button>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-inbox" style="font-size: 3rem; color: #d1d5db; margin-bottom: 1rem;"></i>
                            <p style="color: #6b7280; font-size: 1.1rem;">Nu au fost primite oferte încă.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h6><i class="fas fa-user me-2"></i>Informații Client</h6>
                    
                    <!-- Client Profile Picture -->
                    <div class="text-center mb-3">
                        {% if order.client.profile_picture %}
                            <img src="{{ order.client.profile_picture.url }}" 
                                 alt="Profil client" 
                                 class="rounded-circle shadow-sm"
                                 style="width: 80px; height: 80px; object-fit: cover;">
                        {% else %}
                            <div class="rounded-circle bg-primary d-inline-flex align-items-center justify-content-center text-white shadow-sm"
                                 style="width: 80px; height: 80px; font-size: 2rem;">
                                {{ order.client.first_name|first|default:order.client.username|first|upper }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Client Name -->
                    <div class="text-center mb-3">
                        <h6 class="mb-1">{{ order.client.get_full_name|default:order.client.username }}</h6>
                        <small class="text-muted">
                            <i class="fas fa-calendar-alt me-1"></i>
                            Membru din {{ order.client.date_joined|date:"M Y" }}
                        </small>
                    </div>
                    
                    <!-- Client Details -->
                    <div class="client-details">
                        {% if order.client.phone_number %}
                        <div class="mb-2">
                            <strong><i class="fas fa-phone me-2 text-muted"></i>Telefon:</strong>
                            <div class="d-flex align-items-center">
                                <span class="blurred-phone me-2" id="phone-{{ order.client.id }}">
                                    {{ order.client.phone_number|slice:":3" }}xxxx{{ order.client.phone_number|slice:"-2:" }}
                                </span>
                                <button class="btn btn-sm btn-outline-primary reveal-phone" 
                                        data-phone="{{ order.client.phone_number }}" 
                                        data-target="phone-{{ order.client.id }}"
                                        title="Click pentru a afișa numărul complet">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        {% endif %}
                        
                        <div class="mb-2">
                            <strong><i class="fas fa-envelope me-2 text-muted"></i>Email:</strong>
                            <div>
                                <a href="mailto:{{ order.client.email }}" class="email-link text-break-word">
                                    {{ order.client.email }}
                                </a>
                            </div>
                        </div>
                        
                        <div class="mb-2">
                            <strong><i class="fas fa-map-marker-alt me-2 text-muted"></i>Locație:</strong>
                            <div>{{ order.city.name }}, {{ order.county.name }}</div>
                        </div>
                        
                        <div class="mb-2">
                            <strong><i class="fas fa-user-check me-2 text-muted"></i>Status:</strong>
                            <div>
                                {% if order.client.is_verified %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check-circle me-1"></i>Verificat
                                    </span>
                                {% else %}
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-clock me-1"></i>În verificare
                                    </span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Client Activity Stats -->
                        <div class="mt-3 pt-3 border-top">
                            <small class="text-muted">
                                <div class="d-flex justify-content-between mb-1">
                                    <span><i class="fas fa-shopping-cart me-1"></i>Comenzi active:</span>
                                    <strong>{{ active_orders_count|default:0 }}</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span><i class="fas fa-check-circle me-1"></i>Comenzi finalizate:</span>
                                    <strong>{{ completed_orders_count|default:0 }}</strong>
                                </div>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            {% if can_quote %}
            <div class="card mt-3">
                <div class="card-body">
                    <a href="{% url 'services:create_quote' order.pk %}" class="btn btn-primary w-100">
                        <i class="fas fa-paper-plane me-2"></i>Trimite Ofertă
                    </a>
                </div>
            </div>
            {% elif user.user_type == 'craftsman' and quote_disabled_reason %}
            <div class="card mt-3">
                <div class="card-body">
                    {% if order.status == 'completed' and order.review %}
                        <!-- Comandă completată cu succes și cu review -->
                        <div class="alert alert-success mb-0" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; color: white;">
                            <div class="text-center">
                                <i class="fas fa-check-circle fa-3x mb-3"></i>
                                <h5 class="fw-bold mb-2">Comandă închisă cu succes!</h5>
                                <p class="mb-0">Această comandă a fost finalizată și clientul a lăsat deja o recenzie.</p>
                            </div>
                        </div>
                    {% else %}
                        {% if invitation %}
                            {% if invitation.status == 'pending' %}
                                <div class="alert alert-info alert-permanent">
                                    <h6><i class="fas fa-envelope-open-text me-2"></i>Invitație de la client</h6>
                                    <p class="mb-2">Clientul te-a invitat să ofertezi pentru această lucrare. Acceptă invitația pentru a trimite oferta.</p>
                                    <div class="d-flex gap-2">
                                        <form method="post" action="{% url 'services:accept_invitation' order.pk %}" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-success">
                                                <i class="fas fa-check me-2"></i>Acceptă invitația
                                            </button>
                                        </form>
                                        <form method="post" action="{% url 'services:decline_invitation' order.pk %}" class="d-inline">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-outline-danger" onclick="return confirm('Sigur vrei să refuzi invitația?')">
                                                <i class="fas fa-times me-2"></i>Refuză
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            {% elif invitation.status == 'accepted' %}
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-2"></i>Ai acceptat invitația! Poți trimite oferta.
                                </div>
                            {% endif %}
                        {% endif %}
                        <button class="btn btn-secondary w-100" disabled title="{{ quote_disabled_reason }}">
                            <i class="fas fa-lock me-2"></i>Nu poți licita
                        </button>

                        {% if 'Profil incomplet' in quote_disabled_reason %}
                        <!-- Profile Completion Progress -->
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="fw-bold">Completare profil:</small>
                                <small class="fw-bold text-primary">{{ user.craftsman_profile.profile_completion }}%</small>
                            </div>
                            <div class="progress" style="height: 8px;">
                                <div class="progress-bar" role="progressbar"
                                     style="width: {{ user.craftsman_profile.profile_completion }}%; background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);"
                                     aria-valuenow="{{ user.craftsman_profile.profile_completion }}"
                                     aria-valuemin="0"
                                     aria-valuemax="100"></div>
                            </div>

                            {% if user.craftsman_profile.profile_completion < 100 %}
                            <div class="mt-3">
                                <small class="text-muted d-block mb-2"><strong>Ce mai lipsește:</strong></small>
                                <ul class="list-unstyled small profile-completion-list">
                                    {% if not user.craftsman_profile.display_name %}
                                    <li class="mb-1"><i class="fas fa-circle text-danger" style="font-size: 0.5rem;"></i> Nume afișat (10p)</li>
                                    {% endif %}
                                    {% if not user.craftsman_profile.county or not user.craftsman_profile.city %}
                                    <li class="mb-1"><i class="fas fa-circle text-danger" style="font-size: 0.5rem;"></i> Județ și oraș (10p)</li>
                                    {% endif %}
                                    {% if not user.craftsman_profile.coverage_radius_km or user.craftsman_profile.coverage_radius_km < 5 or user.craftsman_profile.coverage_radius_km > 150 %}
                                    <li class="mb-1"><i class="fas fa-circle text-danger" style="font-size: 0.5rem;"></i> Rază acoperire (10p)</li>
                                    {% endif %}
                                    {% if not user.craftsman_profile.bio or user.craftsman_profile.bio|length < 200 %}
                                    <li class="mb-1"><i class="fas fa-circle text-danger" style="font-size: 0.5rem;"></i> Bio minim 200 caractere (15p)</li>
                                    {% endif %}
                                    {% if not user.craftsman_profile.profile_photo %}
                                    <li class="mb-1"><i class="fas fa-circle text-danger" style="font-size: 0.5rem;"></i> Poză de profil (15p)</li>
                                    {% endif %}
                                    {% if user.craftsman_profile.portfolio_images.count < 3 %}
                                    <li class="mb-1"><i class="fas fa-circle text-warning" style="font-size: 0.5rem;"></i> Portfolio: {{ user.craftsman_profile.portfolio_images.count }}/3 poze (40p)</li>
                                    {% endif %}
                                    {% if not user.craftsman_profile.services.exists %}
                                    <li class="mb-1"><i class="fas fa-circle text-danger" style="font-size: 0.5rem;"></i> Minim 1 serviciu (20p)</li>
                                    {% endif %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>

                        <a href="{% url 'accounts:edit_profile' %}" class="btn btn-primary btn-sm mt-3 w-100">
                            <i class="fas fa-user-edit me-2"></i>Completează profilul
                        </a>
                        {% else %}
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-info-circle me-1"></i>{{ quote_disabled_reason }}
                        </small>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            {% elif user == order.client %}
                <div class="card mt-3">
                    <div class="card-body">
                        {% if order.status == 'draft' %}
                            <a href="{% url 'services:edit_order' order.pk %}" class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-edit me-2"></i>Editează Comanda
                            </a>
                            <form method="post" action="{% url 'services:publish_order' order.pk %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success w-100 mb-2">
                                    <i class="fas fa-check me-2"></i>Publică Comanda
                                </button>
                            </form>
                            <button type="button" class="btn btn-outline-danger w-100" data-bs-toggle="modal" data-bs-target="#deleteOrderModal">
                                <i class="fas fa-trash me-2"></i>Șterge Comanda
                            </button>
                        {% elif order.status == 'published' %}
                            <a href="{% url 'services:edit_order' order.pk %}" class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-edit me-2"></i>Editează Comanda
                            </a>
                            <a href="{% url 'services:invite_craftsmen' order.pk %}" class="btn btn-info w-100 mb-2">
                                <i class="fas fa-user-plus me-2"></i>Invită Meșteri
                            </a>
                            <button type="button" class="btn btn-outline-danger w-100" data-bs-toggle="modal" data-bs-target="#deleteOrderModal">
                                <i class="fas fa-trash me-2"></i>Șterge Comanda
                            </button>
                            <small class="text-muted d-block mt-2">
                                Invită meșteri din zona ta să oferteze pentru această lucrare.
                            </small>
                        {% else %}
                            <a href="{% url 'services:edit_order' order.pk %}" class="btn btn-outline-primary w-100 mb-2">
                                <i class="fas fa-edit me-2"></i>Editează Comanda
                            </a>
                            <button type="button" class="btn btn-outline-danger w-100" data-bs-toggle="modal" data-bs-target="#deleteOrderModal">
                                <i class="fas fa-trash me-2"></i>Șterge Comanda
                            </button>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
</div><!-- End Desktop Layout -->

<!-- Include Universal Lightbox -->
{% if order.images.all %}
{% include "partials/image_lightbox.html" %}
{% endif %}

<!-- Delete Order Confirmation Modal -->
{% if user == order.client %}
<div class="modal fade" id="deleteOrderModal" tabindex="-1" aria-labelledby="deleteOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 bg-danger text-white">
                <h5 class="modal-title fw-bold" id="deleteOrderModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>Confirmare ștergere comandă
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">Ești sigur că vrei să ștergi comanda <strong>"{{ order.title }}"</strong>?</p>
                <div class="alert alert-warning mb-0">
                    <small>
                        <i class="fas fa-info-circle me-1"></i>
                        Această acțiune este <strong>permanentă</strong> și nu poate fi anulată.
                        Toate datele asociate comenzii vor fi șterse definitiv.
                    </small>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Anulează
                </button>
                <form method="post" action="{% url 'services:delete_order' order.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i>Șterge definitiv
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
