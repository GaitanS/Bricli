{% extends 'base.html' %}
{% load static %}
{% load lazy_loading %}
{% load service_icons %}
{% load querystring %}

{% block title %}
    {% if query %}Rezultate pentru "{{ query }}"{% else %}Caută meșteri{% endif %} - Bricli
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/search.css' %}">
{% endblock %}

{% block content %}
<div class="container py-4">
    {# Compact search bar + mobile filter button #}
    {% include "core/search/_filter_bar.html" %}

    {# Mobile offcanvas drawer #}
    {% include "core/search/_filter_offcanvas.html" %}

    {# Two-column layout: sidebar (desktop) + results #}
    <div class="row">
        {# Sidebar - Desktop only, order-1 on desktop #}
        <aside class="col-lg-4 order-2 order-lg-1">
            {% include "core/search/_filter_sidebar.html" %}
        </aside>

        {# Main results area - order-1 on mobile, order-2 on desktop #}
        <main class="col-lg-8 order-1 order-lg-2">
            {# Results header #}
            {% if craftsmen %}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="h4 mb-0">
                        {% if query %}
                            Rezultate pentru <strong>"{{ query }}"</strong>
                        {% else %}
                            Meșteri găsiți
                        {% endif %}
                        <span class="badge bg-secondary">{{ page_obj.paginator.count }}</span>
                    </h2>
                </div>

                {# Sort bar with per-page and view toggle #}
                {% include "core/search/_sort_bar.html" %}

                {# Craftsmen cards #}
                {% for craftsman in craftsmen %}
                <div class="card mb-3 border-0 shadow-sm">
                    <div class="card-body p-3">
                        <div class="row align-items-center">
                            {# Profile photo #}
                            <div class="col-md-2 col-sm-3 text-center mb-2 mb-md-0">
                                {% if craftsman.profile_photo %}
                                    <img src="{{ craftsman.profile_photo.url }}?v={% image_version craftsman.profile_photo fallback_dt=craftsman.updated_at %}"
                                         class="rounded-circle" width="60" height="60"
                                         alt="{{ craftsman.user.get_full_name|default:craftsman.user.username }}"
                                         loading="lazy" style="object-fit: cover;">
                                {% elif craftsman.user.profile_picture %}
                                    <img src="{{ craftsman.user.profile_picture.url }}?v={% profile_img_version craftsman.user %}"
                                         class="rounded-circle" width="60" height="60"
                                         alt="{{ craftsman.user.get_full_name|default:craftsman.user.username }}"
                                         loading="lazy" style="object-fit: cover;">
                                {% else %}
                                    <img src="{% static 'images/avatar.svg' %}"
                                         class="rounded-circle" width="60" height="60"
                                         alt="{{ craftsman.user.get_full_name|default:craftsman.user.username }}"
                                         loading="lazy" style="object-fit: cover;">
                                {% endif %}
                            </div>

                            {# Craftsman info #}
                            <div class="col-md-7 col-sm-9">
                                <div class="d-flex align-items-center mb-1">
                                    <h6 class="card-title mb-0 me-2">
                                        {{ craftsman.display_name|default:craftsman.user.get_full_name|default:"Meșter profesionist" }}
                                    </h6>
                                    {% if craftsman.user.is_verified %}
                                    <span class="badge bg-success badge-sm">
                                        <i class="fas fa-check-circle me-1"></i>Verificat
                                    </span>
                                    {% endif %}
                                </div>

                                <p class="text-muted mb-1 small">
                                    <i class="fas fa-map-marker-alt me-1"></i>{{ craftsman.county.name }}
                                </p>

                                {% if craftsman.bio %}
                                <p class="card-text small text-muted mb-2">{{ craftsman.bio|truncatewords:15 }}</p>
                                {% endif %}

                                {# Rating stars #}
                                <div class="d-flex align-items-center">
                                    <div class="me-3">
                                        {% for i in "12345" %}
                                            {% if forloop.counter <= craftsman.average_rating|floatformat:0|add:0 %}
                                                <i class="fas fa-star text-warning small"></i>
                                            {% else %}
                                                <i class="far fa-star text-muted small"></i>
                                            {% endif %}
                                        {% endfor %}
                                        <span class="ms-1 text-muted small">({{ craftsman.total_reviews|default:0 }})</span>
                                    </div>
                                </div>
                            </div>

                            {# Action buttons #}
                            <div class="col-md-3 text-md-end text-center mt-2 mt-md-0">
                                <div class="d-grid gap-2">
                                    <a href="{% url 'accounts:craftsman_detail' craftsman.pk %}"
                                       class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-eye me-1"></i>Vezi profil
                                    </a>
                                    {% if user != craftsman.user %}
                                        <a href="{% url 'services:create_order' %}?craftsman={{ craftsman.pk }}"
                                           class="btn btn-sm text-white fw-medium"
                                           style="background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);">
                                            <i class="fas fa-comments me-1"></i>Contactează
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}

                {# Pagination #}
                {% if page_obj.has_other_pages %}
                <nav aria-label="Paginare rezultate">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% querystring page=page_obj.previous_page_number %}">
                                <i class="fas fa-chevron-left me-1"></i>Anterior
                            </a>
                        </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                            <li class="page-item active" aria-current="page">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?{% querystring page=num %}">{{ num }}</a>
                            </li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% querystring page=page_obj.next_page_number %}">
                                Următorul<i class="fas fa-chevron-right ms-1"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

            {% else %}
                {# No results #}
                <div class="text-center py-5">
                    <i class="fas fa-search text-muted" style="font-size: 4rem;"></i>
                    <h3 class="mt-3">Nu am găsit rezultate</h3>
                    <p class="text-muted">
                        {% if query %}
                            Nu am găsit meșteri pentru <strong>"{{ query }}"</strong>
                            {% if county %}în județul <strong>{{ county.name }}</strong>{% endif %}
                            {% if active_category %}în categoria <strong>{{ active_category.name }}</strong>{% endif %}.
                        {% else %}
                            Folosește filtrele pentru a găsi meșteri.
                        {% endif %}
                    </p>
                    <div class="mt-4">
                        <a href="{% url 'services:create_order' %}" class="btn btn-primary me-2">
                            <i class="fas fa-plus me-2"></i>Postează o comandă
                        </a>
                        <a href="{% url 'services:categories' %}" class="btn btn-outline-primary">
                            <i class="fas fa-list me-2"></i>Vezi toate serviciile
                        </a>
                    </div>
                </div>
            {% endif %}
        </main>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/search-filters.js' %}"></script>
{% endblock %}
