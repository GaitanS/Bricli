{% extends 'base.html' %}
{% load static %}
{% load lazy_loading %}
{% load service_icons %}
{% load querystring %}

{% block title %}
    {% if query %}Rezultate pentru "{{ query }}"{% else %}Caută meșteri{% endif %} - Bricli
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/search.css' %}">
{% endblock %}

{% block content %}
<div class="container py-4">
    {# Compact search bar + mobile filter button #}
    {% include "core/search/_filter_bar.html" %}

    {# Mobile offcanvas drawer #}
    {% include "core/search/_filter_offcanvas.html" %}

    {# Two-column layout: sidebar (desktop) + results #}
    <div class="row">
        {# Sidebar - Desktop only, order-1 on desktop #}
        <aside class="col-lg-4 order-2 order-lg-1">
            {% include "core/search/_filter_sidebar.html" %}
        </aside>

        {# Main results area - order-1 on mobile, order-2 on desktop #}
        <main class="col-lg-8 order-1 order-lg-2">
            {# Results header #}
            {% if craftsmen %}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h2 class="h4 mb-0">
                        {% if query %}
                            Rezultate pentru <strong>"{{ query }}"</strong>
                        {% else %}
                            Meșteri găsiți
                        {% endif %}
                        <span class="badge bg-secondary">{{ page_obj.paginator.count }}</span>
                    </h2>
                </div>

                {# Results count badge #}
                <div class="results-count">
                    <i class="fas fa-users"></i>
                    <div>
                        <strong>{{ page_obj.paginator.count }} meșteri găsiți</strong>
                    </div>
                </div>

                {# Sort bar with per-page and view toggle #}
                {% include "core/search/_sort_bar.html" %}

                {# Craftsmen cards - Modern layout #}
                <div class="row g-3 row-cols-1 row-cols-md-2">
                    {% for craftsman in craftsmen %}
                    <div class="col">
                        <div class="card craftsman-card h-100">
                            <div class="card-body">
                                <div class="d-flex gap-3 mb-3">
                                    {# Avatar #}
                                    <div>
                                        {% if craftsman.profile_photo %}
                                            <img src="{{ craftsman.profile_photo.url }}?v={% image_version craftsman.profile_photo fallback_dt=craftsman.updated_at %}"
                                                 alt="{{ craftsman.display_name|default:craftsman.user.get_full_name }}"
                                                 class="craftsman-avatar" loading="lazy">
                                        {% elif craftsman.user.profile_picture %}
                                            <img src="{{ craftsman.user.profile_picture.url }}?v={% profile_img_version craftsman.user %}"
                                                 alt="{{ craftsman.display_name|default:craftsman.user.get_full_name }}"
                                                 class="craftsman-avatar" loading="lazy">
                                        {% else %}
                                            <div class="craftsman-avatar bg-light d-flex align-items-center justify-content-center">
                                                <i class="fas fa-user fa-2x text-muted"></i>
                                            </div>
                                        {% endif %}
                                    </div>

                                    {# Info #}
                                    <div class="flex-grow-1">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <h3 class="craftsman-name">{{ craftsman.display_name|default:craftsman.user.get_full_name|default:"Meșter profesionist" }}</h3>
                                            {% if craftsman.user.is_verified %}
                                            <span class="badge-verified">
                                                <i class="fas fa-check-circle me-1"></i>Verificat
                                            </span>
                                            {% endif %}
                                        </div>

                                        <div class="craftsman-location mb-2">
                                            <i class="fas fa-map-marker-alt"></i>
                                            <span>{% if craftsman.city %}{{ craftsman.city.name }}, {% endif %}{{ craftsman.county.name }}</span>
                                        </div>

                                        <div class="craftsman-rating">
                                            <div class="stars" style="color: #8B5CF6;">
                                                {% if craftsman.average_rating > 0 %}
                                                    {% for i in "12345" %}
                                                        {% if forloop.counter <= craftsman.average_rating|floatformat:0|add:0 %}
                                                            <i class="fas fa-star"></i>
                                                        {% else %}
                                                            <i class="far fa-star text-muted"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                {% else %}
                                                    {% for i in "12345" %}
                                                        <i class="far fa-star text-muted"></i>
                                                    {% endfor %}
                                                {% endif %}
                                            </div>
                                            <span><strong>{{ craftsman.average_rating|floatformat:1|default:"0.0" }}</strong> ({{ craftsman.total_reviews }} recenzii)</span>
                                        </div>

                                        {% if craftsman.years_experience %}
                                        <div class="text-muted small mt-2">
                                            <i class="fas fa-calendar-alt me-1"></i>{{ craftsman.years_experience }} ani experiență
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>

                                {# Actions #}
                                <div class="craftsman-actions">
                                    <a href="{% url 'accounts:craftsman_detail' craftsman.pk %}" class="btn-view-profile text-decoration-none">
                                        <i class="fas fa-eye me-2"></i>Vezi profil complet
                                    </a>
                                    {% if user.is_authenticated and user != craftsman.user and user.user_type != 'craftsman' %}
                                    <a href="{% url 'accounts:craftsman_detail' craftsman.pk %}#contactForm" class="btn-message text-decoration-none">
                                        <i class="fas fa-comment me-2"></i>Mesaj
                                    </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>

                {# Pagination #}
                {% if page_obj.has_other_pages %}
                <nav aria-label="Paginare rezultate">
                    <ul class="pagination justify-content-center">
                        {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% querystring page=page_obj.previous_page_number %}">
                                <i class="fas fa-chevron-left me-1"></i>Anterior
                            </a>
                        </li>
                        {% endif %}

                        {% for num in page_obj.paginator.page_range %}
                            {% if page_obj.number == num %}
                            <li class="page-item active" aria-current="page">
                                <span class="page-link">{{ num }}</span>
                            </li>
                            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                            <li class="page-item">
                                <a class="page-link" href="?{% querystring page=num %}">{{ num }}</a>
                            </li>
                            {% endif %}
                        {% endfor %}

                        {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% querystring page=page_obj.next_page_number %}">
                                Următorul<i class="fas fa-chevron-right ms-1"></i>
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

            {% else %}
                {# No results #}
                <div class="text-center py-5">
                    <i class="fas fa-search text-muted" style="font-size: 4rem;"></i>
                    <h3 class="mt-3">Nu am găsit rezultate</h3>
                    <p class="text-muted">
                        {% if query %}
                            Nu am găsit meșteri pentru <strong>"{{ query }}"</strong>
                            {% if county %}în județul <strong>{{ county.name }}</strong>{% endif %}
                            {% if active_category %}în categoria <strong>{{ active_category.name }}</strong>{% endif %}.
                        {% else %}
                            Folosește filtrele pentru a găsi meșteri.
                        {% endif %}
                    </p>
                    <div class="mt-4">
                        <a href="{% url 'services:create_order' %}" class="btn btn-primary me-2">
                            <i class="fas fa-plus me-2"></i>Postează o comandă
                        </a>
                        <a href="{% url 'services:categories' %}" class="btn btn-outline-primary">
                            <i class="fas fa-list me-2"></i>Vezi toate serviciile
                        </a>
                    </div>
                </div>
            {% endif %}
        </main>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/search-filters.js' %}"></script>
{% endblock %}
