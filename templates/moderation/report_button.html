<!-- Report Button Component -->
{% load moderation_tags %}

<div class="dropdown">
    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" 
            data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-flag me-1"></i>Raportează
    </button>
    <ul class="dropdown-menu">
        <li>
            <h6 class="dropdown-header">Raportare rapidă</h6>
        </li>
        <li>
            <a class="dropdown-item quick-report" href="#" 
               data-content-type-id="{{ object|get_content_type_id }}"
               data-object-id="{{ object.id }}"
               data-report-type="spam">
                <i class="fas fa-exclamation-triangle text-warning me-2"></i>Spam
            </a>
        </li>
        <li>
            <a class="dropdown-item quick-report" href="#" 
               data-content-type-id="{{ object|get_content_type_id }}"
               data-object-id="{{ object.id }}"
               data-report-type="inappropriate">
                <i class="fas fa-times-circle text-danger me-2"></i>Conținut nepotrivit
            </a>
        </li>
        <li>
            <a class="dropdown-item quick-report" href="#" 
               data-content-type-id="{{ object|get_content_type_id }}"
               data-object-id="{{ object.id }}"
               data-report-type="fake_profile">
                <i class="fas fa-user-times text-info me-2"></i>Profil fals
            </a>
        </li>
        <li><hr class="dropdown-divider"></li>
        <li>
            <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#reportModal"
               data-content-type-id="{{ object|get_content_type_id }}"
               data-object-id="{{ object.id }}">
                <i class="fas fa-edit me-2"></i>Raportare detaliată
            </a>
        </li>
    </ul>
</div>

<!-- Report Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportModalLabel">
                    <i class="fas fa-flag me-2"></i>Raportează conținut
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="{% url 'moderation:create_report' %}" id="reportForm">
                    {% csrf_token %}
                    <input type="hidden" name="content_type_id" id="reportContentTypeId">
                    <input type="hidden" name="object_id" id="reportObjectId">
                    
                    <div class="mb-3">
                        <label for="reportType" class="form-label">Tipul problemei</label>
                        <select class="form-select" name="report_type" id="reportType" required>
                            <option value="">Selectează tipul problemei</option>
                            <option value="spam">Spam</option>
                            <option value="inappropriate">Conținut nepotrivit</option>
                            <option value="fake_profile">Profil fals</option>
                            <option value="scam">Înșelătorie</option>
                            <option value="harassment">Hărțuire</option>
                            <option value="copyright">Încălcare drepturi de autor</option>
                            <option value="other">Altele</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="reportDescription" class="form-label">Descriere detaliată</label>
                        <textarea class="form-control" name="description" id="reportDescription" 
                                  rows="4" placeholder="Descrie problema în detaliu..." required></textarea>
                        <div class="form-text">
                            Te rugăm să oferi cât mai multe detalii pentru a ne ajuta să analizăm situația.
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <small>
                            Raportările false sau abuzive pot duce la restricționarea contului tău. 
                            Toate raportările sunt analizate de echipa noastră de moderare.
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anulează</button>
                <button type="submit" form="reportForm" class="btn btn-danger">
                    <i class="fas fa-flag me-2"></i>Trimite raportarea
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle quick reports
    document.querySelectorAll('.quick-report').forEach(function(button) {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            
            const contentTypeId = this.dataset.contentTypeId;
            const objectId = this.dataset.objectId;
            const reportType = this.dataset.reportType;
            
            // Send AJAX request for quick report
            fetch(`/moderation/quick-report/${contentTypeId}/${objectId}/${reportType}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success alert-dismissible fade show';
                    alertDiv.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i>${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.querySelector('.container').prepend(alertDiv);
                    
                    // Hide the report button
                    this.closest('.dropdown').style.display = 'none';
                } else {
                    alert('Eroare: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('A apărut o eroare la trimiterea raportării.');
            });
        });
    });
    
    // Handle detailed report modal
    const reportModal = document.getElementById('reportModal');
    if (reportModal) {
        reportModal.addEventListener('show.bs.modal', function(event) {
            const button = event.relatedTarget;
            const contentTypeId = button.dataset.contentTypeId;
            const objectId = button.dataset.objectId;
            
            document.getElementById('reportContentTypeId').value = contentTypeId;
            document.getElementById('reportObjectId').value = objectId;
        });
    }
});
</script>
