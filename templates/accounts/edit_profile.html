{% extends 'base.html' %}
{% load static %}
{% load lazy_loading %}

{% block title %}Editează Profil - Bricli{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="text-center mb-5">
                <h1 class="h2 fw-bold" style="color: #8B5CF6;">Editează Profilul</h1>
                <p class="text-muted">Actualizează informațiile tale personale</p>
            </div>

            <!-- Form Card -->
            <div class="card border-0 shadow-lg">
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- Profile Picture Section -->
                        <div class="text-center mb-4">
                            <div class="profile-picture-container position-relative d-inline-block">
                                <div class="profile-picture-wrapper">
                                    <img id="profile-preview"
                                         src="{% if user.user_type == 'craftsman' and user.craftsman_profile and user.craftsman_profile.profile_photo %}{{ user.craftsman_profile.profile_photo.url }}?v={% image_version user.craftsman_profile.profile_photo fallback_dt=user.craftsman_profile.updated_at %}{% elif user.profile_picture %}{{ user.profile_picture.url }}?v={% profile_img_version user %}{% else %}{% static 'images/avatar.svg' %}{% endif %}"
                                         class="rounded-circle border shadow-sm"
                                         width="120" height="120"
                                         alt="{{ user.get_full_name|default:user.username }}"
                                         style="object-fit: cover;"
                                         loading="lazy">

                                    <!-- Upload overlay -->
                                    <div class="profile-upload-overlay">
                                        <div class="upload-content">
                                            <i class="fas fa-camera fs-4 mb-2"></i>
                                            <div class="small">Schimbă poza</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Action buttons -->
                                <div class="profile-actions mt-3">
                                    <label for="{{ form.profile_picture.id_for_label }}"
                                           class="btn btn-sm text-white me-2"
                                           style="background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);">
                                        <i class="fas fa-upload me-1"></i>Încarcă poză
                                    </label>
                                    {% if user.user_type == 'craftsman' and user.craftsman_profile and user.craftsman_profile.profile_photo %}
                                    <button type="button" id="remove-picture" class="btn btn-outline-danger btn-sm">
                                        <i class="fas fa-trash me-1"></i>Șterge
                                    </button>
                                    {% elif user.profile_picture %}
                                    <button type="button" id="remove-picture" class="btn btn-outline-danger btn-sm">
                                        <i class="fas fa-trash me-1"></i>Șterge
                                    </button>
                                    {% endif %}
                                </div>

                                <div class="mt-2 small text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Formatul recomandat: JPG, PNG (max 5MB)
                                </div>
                            </div>

                            <!-- Hidden file input -->
                            {{ form.profile_picture }}
                            {% if form.profile_picture.errors %}
                                <div class="text-danger small mt-2">
                                    {{ form.profile_picture.errors }}
                                </div>
                            {% endif %}
                        </div>

                        <!-- Personal Information -->
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="{{ form.first_name.id_for_label }}" class="form-label fw-medium">
                                    <i class="fas fa-user me-2" style="color: #8B5CF6;"></i>Prenume
                                </label>
                                {{ form.first_name }}
                                {% if form.first_name.errors %}
                                    <div class="text-danger small mt-1">{{ form.first_name.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.last_name.id_for_label }}" class="form-label fw-medium">
                                    <i class="fas fa-user me-2" style="color: #8B5CF6;"></i>Nume
                                </label>
                                {{ form.last_name }}
                                {% if form.last_name.errors %}
                                    <div class="text-danger small mt-1">{{ form.last_name.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row g-3 mt-2">
                            <div class="col-md-6">
                                <label for="{{ form.email.id_for_label }}" class="form-label fw-medium">
                                    <i class="fas fa-envelope me-2" style="color: #8B5CF6;"></i>Email
                                </label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                    <div class="text-danger small mt-1">{{ form.email.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.phone_number.id_for_label }}" class="form-label fw-medium">
                                    <i class="fas fa-phone me-2" style="color: #8B5CF6;"></i>Telefon
                                </label>
                                {{ form.phone_number }}
                                {% if form.phone_number.errors %}
                                    <div class="text-danger small mt-1">{{ form.phone_number.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Craftsman-specific fields -->
                        {% if user.user_type == 'craftsman' and user.craftsman_profile %}
                            <hr class="my-4">
                            <h5 class="fw-bold mb-3" style="color: #8B5CF6;">
                                <i class="fas fa-tools me-2"></i>Informații Profesionale
                            </h5>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="{{ form.display_name.id_for_label }}" class="form-label fw-medium">
                                        <i class="fas fa-user me-2" style="color: #8B5CF6;"></i>Nume afișat
                                    </label>
                                    {{ form.display_name }}
                                    {% if form.display_name.errors %}
                                        <div class="text-danger small mt-1">{{ form.display_name.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.county.id_for_label }}" class="form-label fw-medium">
                                        <i class="fas fa-map-marker-alt me-2" style="color: #8B5CF6;"></i>Județul
                                    </label>
                                    {{ form.county }}
                                    {% if form.county.errors %}
                                        <div class="text-danger small mt-1">{{ form.county.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label for="{{ form.city.id_for_label }}" class="form-label fw-medium">
                                        <i class="fas fa-city me-2" style="color: #8B5CF6;"></i>Orașul
                                    </label>
                                    {{ form.city }}
                                    {% if form.city.errors %}
                                        <div class="text-danger small mt-1">{{ form.city.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <label for="{{ form.coverage_radius_km.id_for_label }}" class="form-label fw-medium">
                                        <i class="fas fa-route me-2" style="color: #8B5CF6;"></i>Raza de acoperire (km)
                                    </label>
                                    {{ form.coverage_radius_km }}
                                    {% if form.coverage_radius_km.errors %}
                                        <div class="text-danger small mt-1">{{ form.coverage_radius_km.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="mt-3">
                                <label for="{{ form.bio.id_for_label }}" class="form-label fw-medium">
                                    <i class="fas fa-info-circle me-2" style="color: #8B5CF6;"></i>Descrierea ta profesională
                                </label>
                                {{ form.bio }}
                                {% if form.bio.errors %}
                                    <div class="text-danger small mt-1">{{ form.bio.errors }}</div>
                                {% endif %}
                            </div>

                            <hr class="my-4">
                            <h5 class="fw-bold mb-3" style="color: #8B5CF6;">
                                <i class="fas fa-briefcase me-2"></i>Informații Opționale
                            </h5>

                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="{{ form.years_experience.id_for_label }}" class="form-label fw-medium">
                                        <i class="fas fa-calendar me-2" style="color: #8B5CF6;"></i>Ani de experiență
                                    </label>
                                    {{ form.years_experience }}
                                    {% if form.years_experience.errors %}
                                        <div class="text-danger small mt-1">{{ form.years_experience.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.hourly_rate.id_for_label }}" class="form-label fw-medium">
                                        <i class="fas fa-money-bill me-2" style="color: #8B5CF6;"></i>Tarif orientativ pe oră (RON)
                                    </label>
                                    {{ form.hourly_rate }}
                                    {% if form.hourly_rate.errors %}
                                        <div class="text-danger small mt-1">{{ form.hourly_rate.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.min_job_value.id_for_label }}" class="form-label fw-medium">
                                        <i class="fas fa-coins me-2" style="color: #8B5CF6;"></i>Valoarea minimă lucrare (RON)
                                    </label>
                                    {{ form.min_job_value }}
                                    {% if form.min_job_value.errors %}
                                        <div class="text-danger small mt-1">{{ form.min_job_value.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="mt-3">
                                <label for="{{ form.company_cui.id_for_label }}" class="form-label fw-medium">
                                    <i class="fas fa-building me-2" style="color: #8B5CF6;"></i>CUI/CIF
                                </label>
                                {{ form.company_cui }}
                                {% if form.company_cui.errors %}
                                    <div class="text-danger small mt-1">{{ form.company_cui.errors }}</div>
                                {% endif %}
                            </div>

                            <hr class="my-4">
                            <h5 class="fw-bold mb-3" style="color: #8B5CF6;">
                                <i class="fas fa-share-alt me-2"></i>Link-uri Sociale (Opțional)
                            </h5>

                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="{{ form.website_url.id_for_label }}" class="form-label fw-medium">
                                        <i class="fas fa-globe me-2" style="color: #8B5CF6;"></i>Site web
                                    </label>
                                    {{ form.website_url }}
                                    {% if form.website_url.errors %}
                                        <div class="text-danger small mt-1">{{ form.website_url.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.facebook_url.id_for_label }}" class="form-label fw-medium">
                                        <i class="fab fa-facebook me-2" style="color: #8B5CF6;"></i>Facebook
                                    </label>
                                    {{ form.facebook_url }}
                                    {% if form.facebook_url.errors %}
                                        <div class="text-danger small mt-1">{{ form.facebook_url.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-4">
                                    <label for="{{ form.instagram_url.id_for_label }}" class="form-label fw-medium">
                                        <i class="fab fa-instagram me-2" style="color: #8B5CF6;"></i>Instagram
                                    </label>
                                    {{ form.instagram_url }}
                                    {% if form.instagram_url.errors %}
                                        <div class="text-danger small mt-1">{{ form.instagram_url.errors }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                            <a href="{% url 'accounts:profile' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>Înapoi
                            </a>
                            <button type="submit" class="btn text-white fw-medium px-4"
                                    style="background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);">
                                <i class="fas fa-save me-2"></i>Salvează Modificările
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.form-control, .form-select {
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 0.75rem;
    transition: all 0.3s ease;
}

.form-control:focus, .form-select:focus {
    border-color: #8B5CF6;
    box-shadow: 0 0 0 0.2rem rgba(139, 92, 246, 0.25);
}

#id_profile_picture {
    display: none;
}

.btn:hover {
    transform: translateY(-1px);
    transition: all 0.3s ease;
}

/* Profile Picture Styles */
.profile-picture-wrapper {
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
}

.profile-picture-wrapper:hover {
    transform: scale(1.02);
}

.profile-upload-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(139, 92, 246, 0.8);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: all 0.3s ease;
    color: white;
}

.profile-picture-wrapper:hover .profile-upload-overlay {
    opacity: 1;
}

.upload-content {
    text-align: center;
}

.profile-actions {
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s ease;
}

.profile-picture-container:hover .profile-actions {
    opacity: 1;
    transform: translateY(0);
}

.picture-preview {
    border: 3px solid #8B5CF6;
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('{{ form.profile_picture.id_for_label }}');
    const preview = document.getElementById('profile-preview');
    const removeBtn = document.getElementById('remove-picture');
    const wrapper = document.querySelector('.profile-picture-wrapper');

    // File input change handler
    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.classList.add('picture-preview');

                // Show remove button if it doesn't exist
                if (!document.getElementById('remove-picture')) {
                    const removeBtn = document.createElement('button');
                    removeBtn.type = 'button';
                    removeBtn.id = 'remove-picture';
                    removeBtn.className = 'btn btn-outline-danger btn-sm ms-2';
                    removeBtn.innerHTML = '<i class="fas fa-trash me-1"></i>Șterge';
                    document.querySelector('.profile-actions').appendChild(removeBtn);

                    // Add event listener to new button
                    removeBtn.addEventListener('click', removePicture);
                }
            };
            reader.readAsDataURL(file);
        }
    });

    // Remove picture function
    function removePicture() {
        // Reset to default avatar
        preview.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'%3E%3Ccircle cx='60' cy='60' r='60' fill='%23f3f4f6'/%3E%3Cpath d='M60 30c8.284 0 15 6.716 15 15s-6.716 15-15 15-15-6.716-15-15 6.716-15 15-15zm0 40c16.569 0 30 13.431 30 30v20H30V100c0-16.569 13.431-30 30-30z' fill='%236b7280'/%3E%3C/svg%3E";
        preview.classList.remove('picture-preview');
        fileInput.value = '';

        // Add hidden input to indicate picture removal
        let removeInput = document.getElementById('remove-picture-input');
        if (!removeInput) {
            removeInput = document.createElement('input');
            removeInput.type = 'hidden';
            removeInput.name = 'remove_picture';
            removeInput.id = 'remove-picture-input';
            removeInput.value = 'true';
            document.querySelector('form').appendChild(removeInput);
        } else {
            removeInput.value = 'true';
        }

        // Remove the remove button
        const removeBtn = document.getElementById('remove-picture');
        if (removeBtn) {
            removeBtn.remove();
        }
    }

    // Add event listener to existing remove button
    if (removeBtn) {
        removeBtn.addEventListener('click', removePicture);
    }

    // Click on wrapper to trigger file input
    wrapper.addEventListener('click', function() {
        fileInput.click();
    });
});
</script>
{% endblock %}
