{% extends 'base.html' %}
{% load static %}
{% load lazy_loading %}

{% block title %}{{ craftsman.display_name }} - Meșter {{ craftsman.services.first.service.category.name|default:"Profesionist" }} - Bricli{% endblock %}

{% block content %}
<div class="container-fluid py-5" style="background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);">
    <!-- Hero Section -->
    <div class="row align-items-center mb-5">
        <div class="col-md-2 text-center mb-3 mb-md-0">
            {% if profile_photo_url %}
                <img src="{{ profile_photo_url }}" alt="{{ craftsman.display_name }}" class="rounded-circle shadow-lg" width="120" height="120" style="object-fit: cover;">
            {% else %}
                <div class="bg-primary text-white rounded-circle shadow-lg d-inline-flex align-items-center justify-content-center"
                     style="width: 120px; height: 120px; font-size: 2.5rem;">
                    <i class="fas fa-user"></i>
                </div>
            {% endif %}
        </div>
        <div class="col-md-6">
            <h1 class="h2 fw-bold mb-2" style="color: #1e293b;">
                {{ craftsman.display_name }}
            </h1>
            <p class="text-muted mb-3">
                <i class="fas fa-tools me-2"></i>
                {% for service in craftsman.services.all|slice:":3" %}
                    {{ service.service.name }}{% if not forloop.last %}, {% endif %}
                {% endfor %}
                {% if craftsman.services.count > 3 %}
                    și alte {{ craftsman.services.count|add:"-3" }} servicii
                {% endif %}
            </p>
            <div class="d-flex align-items-center mb-3">
                <div class="me-4">
                    {% if craftsman.average_rating %}
                        {% for i in "12345" %}
                            {% if forloop.counter <= craftsman.average_rating %}
                                <i class="fas fa-star text-warning"></i>
                            {% else %}
                                <i class="far fa-star text-muted"></i>
                            {% endif %}
                        {% endfor %}
                        <span class="ms-2 fw-medium">{{ craftsman.average_rating|floatformat:1 }}</span>
                        <small class="text-muted ms-1">
                            <a href="#reviews-section"
                               style="color: #6c757d; text-decoration: none; transition: color 0.2s ease;"
                               onmouseover="this.style.color='#8B5CF6'; this.style.textDecoration='underline';"
                               onmouseout="this.style.color='#6c757d'; this.style.textDecoration='none';">
                                ({{ craftsman.total_reviews }} recenzii)
                            </a>
                        </small>
                    {% else %}
                        <span class="text-muted">Fără recenzii încă</span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="row text-center">
                <div class="col-4">
                    <div class="p-2">
                        <div class="h4 mb-1" style="color: #8B5CF6;">{{ craftsman.total_reviews }}</div>
                        <small class="text-muted">Recenzii</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="p-2">
                        <div class="h4 mb-1" style="color: #8B5CF6;">{{ craftsman.services.count }}</div>
                        <small class="text-muted">Servicii</small>
                    </div>
                </div>
                <div class="col-4">
                    <div class="p-2">
                        <div class="h4 mb-1" style="color: #8B5CF6;">
                            {% if craftsman.years_experience %}{{ craftsman.years_experience }}+{% else %}5+{% endif %}
                        </div>
                        <small class="text-muted">Ani exp.</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mb-4">
            <!-- Contact Actions -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    {% if user == craftsman.user %}
                    <div class="alert alert-info alert-permanent mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Acesta este profilul tău</strong><br>
                        <small>Așa îți văd clienții profilul pe platformă.</small>
                    </div>
                    {% elif not user.is_authenticated %}
                    <div class="alert alert-info alert-permanent mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Pentru a contacta meșterul</strong><br>
                        <small>Trebuie să te <a href="{% url 'auth:login' %}?next={{ request.get_full_path }}" class="alert-link">autentifici</a> sau să îți <a href="{% url 'auth:register' %}" class="alert-link">creezi un cont</a>.</small>
                    </div>
                    {% elif user.is_authenticated and user.user_type == 'craftsman' and user != craftsman.user %}
                    <div class="alert alert-warning alert-permanent mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Nu se pot trimite mesaje între meșteri</strong><br>
                        <small>Doar clienții pot contacta meșterii prin platformă.</small>
                    </div>
                    {% endif %}
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            {% if user.is_authenticated and user != craftsman.user and user.user_type != 'craftsman' %}
                            <button class="btn btn-lg w-100 text-white fw-bold"
                                    style="background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);"
                                    data-bs-toggle="modal" data-bs-target="#contactModal">
                                <i class="fas fa-comments me-2"></i>Contactează meșterul
                            </button>
                            {% elif not user.is_authenticated %}
                            <a href="{% url 'auth:login' %}?next={{ request.get_full_path }}" 
                               class="btn btn-lg w-100 text-white fw-bold"
                               style="background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);">
                                <i class="fas fa-comments me-2"></i>Contactează meșterul
                            </a>
                            {% else %}
                            <button class="btn btn-lg w-100 text-white fw-bold disabled" disabled
                                    style="background: #6c757d;">
                                <i class="fas fa-comments me-2"></i>Contactează meșterul
                            </button>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {% if user.is_authenticated and user != craftsman.user and user.user_type != 'craftsman' %}
                            <a href="{% url 'services:create_order' %}?craftsman={{ craftsman.pk }}" 
                               class="btn btn-outline-primary btn-lg w-100 fw-bold">
                                <i class="fas fa-plus me-2"></i>Solicită ofertă
                            </a>
                            {% elif not user.is_authenticated %}
                            <a href="{% url 'auth:login' %}?next={{ request.get_full_path }}" 
                               class="btn btn-outline-primary btn-lg w-100 fw-bold">
                                <i class="fas fa-plus me-2"></i>Solicită ofertă
                            </a>
                            {% else %}
                            <button class="btn btn-outline-secondary btn-lg w-100 fw-bold disabled" disabled>
                                <i class="fas fa-plus me-2"></i>Solicită ofertă
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    <!-- Remove the redundant "Trimite mesaj" button row -->
                </div>
            </div>
            <!-- About Section -->
            {% if craftsman.bio %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-user me-2" style="color: #8B5CF6;"></i>Despre meșter
                    </h5>
                    <p class="text-muted mb-0">
                        {{ craftsman.bio|default:"Meșter profesionist cu experiență în domeniu." }}
                    </p>
                </div>
            </div>
            {% endif %}

            <!-- Services Section -->
            {% if craftsman.services.exists %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-tools me-2" style="color: #8B5CF6;"></i>Servicii oferite
                    </h5>
                    <div class="row g-3">
                        {% for craftsman_service in craftsman.services.all %}
                        <div class="col-md-6">
                            <div class="d-flex align-items-center p-3 bg-light rounded">
                                <i class="fas fa-check-circle me-3" style="color: #8B5CF6;"></i>
                                <div>
                                    <h6 class="mb-1">{{ craftsman_service.service.name }}</h6>
                                    {% if craftsman_service.price_from %}
                                        <small class="text-muted">
                                            De la {{ craftsman_service.price_from }} RON
                                            {% if craftsman_service.price_unit %}{{ craftsman_service.price_unit }}{% endif %}
                                        </small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Portfolio -->
            {% if portfolio_images %}
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-images me-2" style="color: #8B5CF6;"></i>Portfolio
                    </h5>
                    <div class="row g-3">
                        {% for image in portfolio_images %}
                        <div class="col-lg-4 col-md-6">
                            <div class="position-relative overflow-hidden rounded">
                                <img src="{{ image.image.url }}" alt="{{ image.title }}" class="img-fluid w-100 portfolio-image" data-index="{{ forloop.counter0 }}" width="300" height="200" style="object-fit: cover; cursor: pointer; transition: transform 0.3s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                {% if image.title %}
                                    <div class="position-absolute bottom-0 start-0 end-0 bg-gradient-dark text-white p-2">
                                        <small class="fw-medium">{{ image.title }}</small>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    {% if craftsman.portfolio_images.count > 6 %}
                    <div class="text-center mt-4">
                        <button class="btn btn-outline-primary">
                            <i class="fas fa-plus me-2"></i>Vezi toate imaginile ({{ craftsman.portfolio_images.count }})
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Reviews -->
            <div class="card border-0 shadow-sm mb-4" id="reviews-section">
                <div class="card-body p-4">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-star me-2" style="color: #8B5CF6;"></i>Recenzii
                        {% if craftsman.total_reviews > 0 %}
                            <span class="badge bg-light text-dark ms-2">{{ craftsman.total_reviews }}</span>
                        {% endif %}
                    </h5>

                    {% if reviews %}
                        <div id="reviews-container">
                            {% for review in reviews %}
                            <div class="review-item border-bottom pb-4 mb-4" data-review-id="{{ review.pk }}">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-2" style="width: 36px; height: 36px;">
                                                <i class="fas fa-user text-muted"></i>
                                            </div>
                                            <div>
                                                <strong>{% if review.client %}{{ review.client.get_full_name|default:review.client.username }}{% else %}Client{% endif %}</strong>
                                                <div class="text-muted small">{{ review.created_at|date:"d M Y" }}</div>
                                            </div>
                                        </div>
                                        <div>
                                            {% for i in "12345" %}
                                                {% if forloop.counter <= review.rating %}
                                                    <i class="fas fa-star text-warning"></i>
                                                {% else %}
                                                    <i class="far fa-star text-muted"></i>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                    <span class="badge bg-success">Verificat</span>
                                </div>
                                {% if review.comment %}
                                <p class="mb-3">{{ review.comment }}</p>
                                {% endif %}

                                <!-- Review Images -->
                                {% if review.images.exists %}
                                <div class="review-images-grid mt-3">
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-images me-2" style="color: #8B5CF6;"></i>
                                        <small class="text-muted">{{ review.images.count }} {{ review.images.count|pluralize:"imagine,imagini" }}</small>
                                    </div>
                                    <div class="row g-2">
                                        {% for image in review.images.all %}
                                        <div class="col-4 col-sm-3 col-md-2">
                                            <img src="{{ image.image.url }}"
                                                 alt="Review image {{ forloop.counter }}"
                                                 class="img-fluid rounded shadow-sm review-thumbnail-profile"
                                                 style="height: 80px; width: 100%; object-fit: cover; cursor: pointer; transition: all 0.3s ease;"
                                                 onmouseover="this.style.transform='scale(1.05)'"
                                                 onmouseout="this.style.transform='scale(1)'"
                                                 data-title="{{ image.description }}">
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Load More Button -->
                        {% if craftsman.total_reviews > 5 %}
                        <div class="text-center mt-4" id="load-more-reviews-container">
                            <button class="btn btn-outline-primary" id="load-more-reviews" data-craftsman-id="{{ craftsman.pk }}" data-offset="5">
                                <i class="fas fa-plus-circle me-2"></i>Mai multe recenzii
                                <span id="reviews-remaining" class="badge bg-primary ms-2">{{ craftsman.total_reviews|add:"-5" }}</span>
                            </button>
                            <div id="reviews-loading" class="d-none mt-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Se încarcă...</span>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-comments fa-2x mb-3"></i>
                            <p>Încă nu există recenzii pentru acest meșter.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Location and Availability -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-map-marker-alt me-2" style="color: #8B5CF6;"></i>Locație
                    </h5>
                    <div class="mb-3">
                        <div class="d-flex align-items-center text-muted">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            {{ craftsman.city.name }}, {{ craftsman.county.name }}
                        </div>
                        <div class="d-flex align-items-center text-muted mt-2">
                            <i class="fas fa-road me-2"></i>
                            Rază acoperire: {{ craftsman.coverage_radius_km }} km
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Info (Authenticated Users Only) -->
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h5 class="card-title mb-3">
                        <i class="fas fa-phone me-2" style="color: #8B5CF6;"></i>Date de contact
                    </h5>

                    {% if user.is_authenticated %}
                        <div class="contact-info">
                            {% if craftsman.phone or craftsman.user.phone_number %}
                                <p class="mb-2">
                                    <i class="fas fa-phone me-2"></i>
                                    <a href="tel:{{ craftsman.phone|default:craftsman.user.phone_number }}" class="text-decoration-none">
                                        {{ craftsman.phone|default:craftsman.user.phone_number }}
                                    </a>
                                </p>
                            {% endif %}
                            {% if craftsman.user.email %}
                                <p class="mb-2">
                                    <i class="fas fa-envelope me-2"></i>
                                    <a href="mailto:{{ craftsman.user.email }}" class="text-decoration-none">{{ craftsman.user.email }}</a>
                                </p>
                            {% endif %}
                            {% if craftsman.user.phone_number %}
                                <p class="mb-2">
                                    <i class="fab fa-whatsapp me-2"></i>
                                    <a href="{{ craftsman.user.get_whatsapp_link }}" target="_blank" class="text-decoration-none">
                                        WhatsApp
                                    </a>
                                </p>
                            {% endif %}
                            {% if craftsman.website_url %}
                                <p class="mb-2">
                                    <i class="fas fa-globe me-2"></i>
                                    <a href="{{ craftsman.website_url }}" target="_blank" class="text-decoration-none">Website</a>
                                </p>
                            {% endif %}
                            {% if craftsman.facebook_url %}
                                <p class="mb-2">
                                    <i class="fab fa-facebook me-2"></i>
                                    <a href="{{ craftsman.facebook_url }}" target="_blank" class="text-decoration-none">Facebook</a>
                                </p>
                            {% endif %}
                            {% if craftsman.instagram_url %}
                                <p class="mb-2">
                                    <i class="fab fa-instagram me-2"></i>
                                    <a href="{{ craftsman.instagram_url }}" target="_blank" class="text-decoration-none">Instagram</a>
                                </p>
                            {% endif %}
                            {% if craftsman.city and craftsman.county %}
                                <p class="mb-0">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    {{ craftsman.city.name }}, {{ craftsman.county.name }}
                                </p>
                            {% endif %}
                        </div>
                    {% else %}
                        <!-- Alert for unauthenticated users -->
                        <div class="alert text-center mb-0" style="background: linear-gradient(135deg, #f5f3ff 0%, #ede9fe 100%); border: 2px solid #8B5CF6;">
                            <div class="mb-3">
                                <i class="fas fa-lock fa-3x mb-3" style="color: #8B5CF6;"></i>
                                <h6 class="fw-bold mb-2" style="color: #5b21b6;">Creează un cont pentru a vedea datele de contact</h6>
                                <p class="small mb-3" style="color: #6b21a8;">
                                    Pentru a proteja meșterii de spam, datele de contact sunt disponibile doar pentru clienți înregistrați.
                                </p>
                            </div>
                            <a href="{% url 'auth:register' %}?type=client&next={{ request.get_full_path }}"
                               class="btn btn-lg text-white fw-bold w-100 mb-3"
                               style="background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%); border: none; box-shadow: 0 4px 6px rgba(139, 92, 246, 0.3);">
                                <i class="fas fa-user-plus me-2"></i>Creează cont gratuit
                            </a>
                            <div class="mt-2">
                                <small style="color: #6b21a8;">
                                    Ai deja cont? <a href="{% url 'auth:login' %}?next={{ request.get_full_path }}" class="fw-bold" style="color: #8B5CF6; text-decoration: none;">Autentifică-te</a>
                                </small>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Contact Modal -->
<div class="modal fade" id="contactModal" tabindex="-1" aria-labelledby="contactModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contactModalLabel">
                    <i class="fas fa-comments me-2"></i>Contactează pe {{ craftsman.display_name }}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Data Protection Notice -->
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Comunicare directă</strong><br>
                    <small>
                        Poți contacta direct meșterul folosind datele de contact de mai sus
                        sau prin formularul de mai jos pentru comunicare prin platformă.
                    </small>
                </div>

                {% if user.is_authenticated %}
                    <form method="post" action="{% url 'messaging:send_contact_message' craftsman.id %}" id="contactForm">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="messageSubject" class="form-label">Subiect</label>
                            <input type="text" class="form-control" id="messageSubject" name="subject"
                                   placeholder="ex. Întrebare despre servicii" required>
                        </div>
                        <div class="mb-3">
                            <label for="messageContent" class="form-label">Mesaj</label>
                            <textarea class="form-control" id="messageContent" name="message" rows="4"
                                      placeholder="Scrie mesajul tău aici..." required></textarea>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane me-2"></i>Trimite mesaj
                            </button>
                        </div>
                    </form>
                {% else %}
                    <div class="text-center">
                        <p class="text-muted mb-3">Pentru a contacta meșterul, trebuie să te autentifici.</p>
                        <a href="{% url 'auth:login' %}?next={{ request.get_full_path }}" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt me-2"></i>Autentifică-te
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Include Universal Lightbox -->
{% include "partials/image_lightbox.html" %}

<!-- Initialize Lightbox for Portfolio Images -->
<script src="{% static 'js/lightbox.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize lightbox for portfolio images
    BricliLightbox.init('.portfolio-image', {
        title: 'Portfolio',
        showCaption: true,
        initGuardKey: 'portfolioLightboxInit'
    });

    // Initialize lightbox for review images
    BricliLightbox.init('.review-thumbnail-profile', {
        title: 'Imagini Recenzii',
        showCaption: true,
        initGuardKey: 'reviewImagesProfileInit'
    });

    // Load More Reviews Functionality
    const loadMoreBtn = document.getElementById('load-more-reviews');
    if (loadMoreBtn) {
        loadMoreBtn.addEventListener('click', async function() {
            const craftsmanId = this.dataset.craftsmanId;
            let offset = parseInt(this.dataset.offset);
            const reviewsContainer = document.getElementById('reviews-container');
            const reviewsLoading = document.getElementById('reviews-loading');
            const reviewsRemaining = document.getElementById('reviews-remaining');

            // Show loading spinner
            this.classList.add('d-none');
            reviewsLoading.classList.remove('d-none');

            try {
                const response = await fetch(`/accounts/craftsman/${craftsmanId}/reviews/?offset=${offset}&limit=10`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();

                // Append new reviews
                if (data.reviews && data.reviews.length > 0) {
                    data.reviews.forEach(review => {
                        const reviewHtml = `
                            <div class="review-item border-bottom pb-4 mb-4" data-review-id="${review.id}">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-2" style="width: 36px; height: 36px;">
                                                <i class="fas fa-user text-muted"></i>
                                            </div>
                                            <div>
                                                <strong>${review.client_name || 'Client'}</strong>
                                                <div class="text-muted small">${review.created_at}</div>
                                            </div>
                                        </div>
                                        <div>
                                            ${generateStars(review.rating)}
                                        </div>
                                    </div>
                                    <span class="badge bg-success">Verificat</span>
                                </div>
                                ${review.comment ? `<p class="mb-3">${escapeHtml(review.comment)}</p>` : ''}
                                ${generateReviewImages(review)}
                            </div>
                        `;
                        reviewsContainer.insertAdjacentHTML('beforeend', reviewHtml);

                        // Re-initialize lightbox for newly added images
                        if (review.images && review.images.length > 0) {
                            setTimeout(() => {
                                BricliLightbox.init('.review-thumbnail-profile', {
                                    title: 'Imagini Recenzii',
                                    showCaption: true,
                                    initGuardKey: 'reviewImagesProfileInit'
                                });
                            }, 100);
                        }
                    });

                    // Update offset and remaining count
                    offset += data.reviews.length;
                    this.dataset.offset = offset;
                    const remaining = data.total_reviews - offset;

                    if (remaining > 0) {
                        reviewsRemaining.textContent = remaining;
                        this.classList.remove('d-none');
                        reviewsLoading.classList.add('d-none');
                    } else {
                        // No more reviews, hide button
                        document.getElementById('load-more-reviews-container').style.display = 'none';
                    }
                } else {
                    // No more reviews
                    document.getElementById('load-more-reviews-container').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading reviews:', error);
                alert('A apărut o eroare la încărcarea recenziilor. Te rugăm să încerci din nou.');
                this.classList.remove('d-none');
                reviewsLoading.classList.add('d-none');
            }
        });
    }

    // Helper function to generate star HTML
    function generateStars(rating) {
        let starsHtml = '';
        for (let i = 1; i <= 5; i++) {
            if (i <= rating) {
                starsHtml += '<i class="fas fa-star text-warning"></i>';
            } else {
                starsHtml += '<i class="far fa-star text-muted"></i>';
            }
        }
        return starsHtml;
    }

    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Helper function to generate review images HTML
    function generateReviewImages(review) {
        if (!review.images || review.images.length === 0) {
            return '';
        }

        let imagesHtml = `
            <div class="review-images-grid mt-3">
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-images me-2" style="color: #8B5CF6;"></i>
                    <small class="text-muted">${review.images_count} ${review.images_count === 1 ? 'imagine' : 'imagini'}</small>
                </div>
                <div class="row g-2">
        `;

        review.images.forEach((image, index) => {
            imagesHtml += `
                <div class="col-4 col-sm-3 col-md-2">
                    <img src="${image.url}"
                         alt="Review image ${index + 1}"
                         class="img-fluid rounded shadow-sm review-thumbnail-profile"
                         style="height: 80px; width: 100%; object-fit: cover; cursor: pointer; transition: all 0.3s ease;"
                         onmouseover="this.style.transform='scale(1.05)'"
                         onmouseout="this.style.transform='scale(1)'"
                         data-title="${escapeHtml(image.description)}">
                </div>
            `;
        });

        imagesHtml += `
                </div>
            </div>
        `;

        return imagesHtml;
    }
});
</script>
{% endblock %}
